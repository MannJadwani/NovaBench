<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Editor Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .tool-active {
            background-color: rgb(99 102 241) !important;
            color: white !important;
        }
        .layer-active {
            background-color: rgb(219 234 254) !important;
            border: 1px solid rgb(96 165 250) !important;
        }
        #canvas-container {
            cursor: crosshair;
        }
        #canvas-container.hand-tool {
            cursor: grab;
        }
        #canvas-container.hand-tool:active {
            cursor: grabbing;
        }
        #canvas-container.zoom-tool {
            cursor: zoom-in;
        }
        #canvas-container.eyedropper-tool {
            cursor: crosshair;
        }
        .history-item:hover {
            background-color: rgb(243 244 246);
        }
        .history-item.active {
            background-color: rgb(219 234 254);
            border-left: 3px solid rgb(59 130 246);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 overflow-hidden">
    <!-- Header -->
    <header class="bg-gray-800 text-white p-2 flex items-center justify-between shadow-lg">
        <div class="flex items-center space-x-4">
            <h1 class="text-xl font-bold flex items-center">
                <i class="fas fa-palette mr-2"></i> Photo Editor Pro
            </h1>
            <nav class="flex space-x-1">
                <button class="px-3 py-1 hover:bg-gray-700 rounded" onclick="app.newDocument()">
                    <i class="fas fa-file mr-1"></i> New
                </button>
                <button class="px-3 py-1 hover:bg-gray-700 rounded" onclick="document.getElementById('file-input').click()">
                    <i class="fas fa-folder-open mr-1"></i> Open
                </button>
                <input type="file" id="file-input" accept="image/*" class="hidden" onchange="app.openImage(event)">
                <button class="px-3 py-1 hover:bg-gray-700 rounded" onclick="app.saveImage()">
                    <i class="fas fa-save mr-1"></i> Save
                </button>
            </nav>
        </div>
        <div class="flex items-center space-x-4">
            <div class="text-sm">
                <span class="opacity-75">Zoom:</span>
                <span id="zoom-level" class="font-mono">100%</span>
            </div>
            <div class="text-sm">
                <span id="cursor-position">X: 0, Y: 0</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex h-screen pt-10">
        <!-- Left Panel - Tools -->
        <div class="w-16 bg-gray-200 shadow-lg flex flex-col items-center py-4 space-y-2">
            <button class="tool-btn w-12 h-12 flex items-center justify-center bg-white hover:bg-gray-300 rounded-lg" data-tool="move" title="Move Tool (V)">
                <i class="fas fa-arrows-alt"></i>
            </button>
            <button class="tool-btn w-12 h-12 flex items-center justify-center bg-white hover:bg-gray-300 rounded-lg" data-tool="rect" title="Rectangle Selection (M)">
                <i class="fas fa-square"></i>
            </button>
            <button class="tool-btn w-12 h-12 flex items-center justify-center bg-white hover:bg-gray-300 rounded-lg" data-tool="lasso" title="Lasso Tool (L)">
                <i class="fas fa-draw-polygon"></i>
            </button>
            <button class="tool-btn w-12 h-12 flex items-center justify-center bg-white hover:bg-gray-300 rounded-lg" data-tool="magicwand" title="Magic Wand (W)">
                <i class="fas fa-wand-magic-sparkles"></i>
            </button>
            <div class="h-px w-8 bg-gray-400 my-2"></div>
            <button class="tool-btn w-12 h-12 flex items-center justify-center bg-white hover:bg-gray-300 rounded-lg tool-active" data-tool="brush" title="Brush Tool (B)">
                <i class="fas fa-paint-brush"></i>
            </button>
            <button class="tool-btn w-12 h-12 flex items-center justify-center bg-white hover:bg-gray-300 rounded-lg" data-tool="pencil" title="Pencil Tool (P)">
                <i class="fas fa-pencil"></i>
            </button>
            <button class="tool-btn w-12 h-12 flex items-center justify-center bg-white hover:bg-gray-300 rounded-lg" data-tool="eraser" title="Eraser Tool (E)">
                <i class="fas fa-eraser"></i>
            </button>
            <div class="h-px w-8 bg-gray-400 my-2"></div>
            <button class="tool-btn w-12 h-12 flex items-center justify-center bg-white hover:bg-gray-300 rounded-lg" data-tool="clonestamp" title="Clone Stamp (S)">
                <i class="fas fa-stamp"></i>
            </button>
            <button class="tool-btn w-12 h-12 flex items-center justify-center bg-white hover:bg-gray-300 rounded-lg" data-tool="text" title="Text Tool (T)">
                <i class="fas fa-font"></i>
            </button>
            <div class="h-px w-8 bg-gray-400 my-2"></div>
            <button class="tool-btn w-12 h-12 flex items-center justify-center bg-white hover:bg-gray-300 rounded-lg" data-tool="eyedropper" title="Eye Dropper (I)">
                <i class="fas fa-eye-dropper"></i>
            </button>
            <button class="tool-btn w-12 h-12 flex items-center justify-center bg-white hover:bg-gray-300 rounded-lg" data-tool="zoom" title="Zoom Tool (Z)">
                <i class="fas fa-search-plus"></i>
            </button>
            <button class="tool-btn w-12 h-12 flex items-center justify-center bg-white hover:bg-gray-300 rounded-lg" data-tool="hand" title="Hand Tool (H)">
                <i class="fas fa-hand-paper"></i>
            </button>
        </div>

        <!-- Canvas Area -->
        <div class="flex-1 bg-gray-300 flex items-center justify-center relative overflow-hidden">
            <div id="canvas-container" class="relative bg-white shadow-2xl">
                <canvas id="main-canvas" width="800" height="600"></canvas>
                <canvas id="overlay-canvas" width="800" height="600" class="absolute top-0 left-0 pointer-events-none"></canvas>
            </div>
            
            <!-- Color Picker -->
            <div class="absolute top-4 left-4 bg-white rounded-lg shadow-lg p-3 fade-in">
                <div class="flex space-x-3">
                    <div class="flex flex-col items-center">
                        <div id="primary-color" class="w-12 h-12 border-2 border-gray-300 rounded cursor-pointer" style="background-color: #000000"></div>
                        <span class="text-xs mt-1">Primary</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <div id="secondary-color" class="w-12 h-12 border-2 border-gray-300 rounded cursor-pointer" style="background-color: #FFFFFF"></div>
                        <span class="text-xs mt-1">Secondary</span>
                    </div>
                </div>
                <input type="color" id="color-picker" class="mt-3 w-full h-8 cursor-pointer">
                <div class="mt-2 text-xs">
                    <input type="text" id="hex-input" class="w-full border rounded px-1 py-1 font-mono" value="#000000">
                </div>
            </div>
        </div>

        <!-- Right Panel - Layers and Adjustments -->
        <div class="w-80 bg-gray-200 shadow-lg flex flex-col">
            <!-- Tabs -->
            <div class="flex border-b border-gray-300">
                <button class="flex-1 py-3 px-4 bg-white border-b-2 border-blue-500 font-medium" onclick="app.switchTab('layers')">
                    Layers
                </button>
                <button class="flex-1 py-3 px-4 hover:bg-gray-100 font-medium" onclick="app.switchTab('adjustments')">
                    Adjustments
                </button>
                <button class="flex-1 py-3 px-4 hover:bg-gray-100 font-medium" onclick="app.switchTab('filters')">
                    Filters
                </button>
            </div>

            <!-- Layers Panel -->
            <div id="layers-panel" class="flex-1 overflow-y-auto p-3 bg-white">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold">Layers</h3>
                    <div class="flex space-x-1">
                        <button class="p-1 hover:bg-gray-200 rounded" onclick="app.addLayer()" title="Add Layer">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="p-1 hover:bg-gray-200 rounded" onclick="app.deleteLayer()" title="Delete Layer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div id="layers-list" class="space-y-2">
                    <!-- Layers will be dynamically added here -->
                </div>
            </div>

            <!-- Adjustments Panel -->
            <div id="adjustments-panel" class="flex-1 overflow-y-auto p-3 bg-white hidden">
                <h3 class="font-semibold mb-3">Adjustments</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Brightness</label>
                        <input type="range" id="brightness" min="-100" max="100" value="0" class="w-full" onchange="app.applyAdjustment('brightness', this.value)">
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>-100</span>
                            <span id="brightness-value">0</span>
                            <span>100</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Contrast</label>
                        <input type="range" id="contrast" min="-100" max="100" value="0" class="w-full" onchange="app.applyAdjustment('contrast', this.value)">
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>-100</span>
                            <span id="contrast-value">0</span>
                            <span>100</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Hue</label>
                        <input type="range" id="hue" min="0" max="360" value="0" class="w-full" onchange="app.applyAdjustment('hue', this.value)">
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>0</span>
                            <span id="hue-value">0</span>
                            <span>360</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Saturation</label>
                        <input type="range" id="saturation" min="-100" max="100" value="0" class="w-full" onchange="app.applyAdjustment('saturation', this.value)">
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>-100</span>
                            <span id="saturation-value">0</span>
                            <span>100</span>
                        </div>
                    </div>
                    
                    <button class="w-full py-2 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="app.resetAdjustments()">
                        Reset Adjustments
                    </button>
                </div>
            </div>

            <!-- Filters Panel -->
            <div id="filters-panel" class="flex-1 overflow-y-auto p-3 bg-white hidden">
                <h3 class="font-semibold mb-3">Filters</h3>
                <div class="space-y-2">
                    <button class="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded text-left px-3" onclick="app.applyFilter('grayscale')">
                        <i class="fas fa-adjust mr-2"></i> Grayscale
                    </button>
                    <button class="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded text-left px-3" onclick="app.applyFilter('sepia')">
                        <i class="fas fa-image mr-2"></i> Sepia
                    </button>
                    <button class="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded text-left px-3" onclick="app.applyFilter('invert')">
                        <i class="fas fa-exchange-alt mr-2"></i> Invert
                    </button>
                    <button class="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded text-left px-3" onclick="app.applyFilter('blur')">
                        <i class="fas fa-circle mr-2"></i> Blur
                    </button>
                    <button class="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded text-left px-3" onclick="app.applyFilter('sharpen')">
                        <i class="fas fa-angle-double-up mr-2"></i> Sharpen
                    </button>
                    <button class="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded text-left px-3" onclick="app.applyFilter('edge')">
                        <i class="fas fa-border-style mr-2"></i> Edge Detect
                    </button>
                    <button class="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded text-left px-3" onclick="app.applyFilter('emboss')">
                        <i class="fas fa-cube mr-2"></i> Emboss
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Panel - History -->
    <div class="fixed bottom-0 left-0 right-0 h-40 bg-gray-800 text-white shadow-lg">
        <div class="p-2 bg-gray-700 flex justify-between items-center">
            <h3 class="font-semibold text-sm">History</h3>
            <div class="flex space-x-2">
                <button class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-sm" onclick="app.undo()">
                    <i class="fas fa-undo mr-1"></i> Undo (Ctrl+Z)
                </button>
                <button class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-sm" onclick="app.redo()">
                    <i class="fas fa-redo mr-1"></i> Redo (Ctrl+Y)
                </button>
            </div>
        </div>
        <div id="history-panel" class="p-3 overflow-y-auto h-32">
            <div id="history-list" class="flex space-x-2">
                <!-- History items will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- Tool Options Bar -->
    <div id="tool-options" class="absolute top-16 left-20 bg-white rounded-lg shadow-lg p-3 fade-in">
        <div id="brush-options" class="tool-options-content">
            <label class="text-sm font-medium">Brush Size</label>
            <input type="range" id="brush-size" min="1" max="50" value="5" class="w-32">
            <span id="brush-size-value" class="ml-2 text-sm">5px</span>
            
            <div class="mt-2">
                <label class="text-sm font-medium">Hardness</label>
                <input type="range" id="brush-hardness" min="0" max="100" value="100" class="w-32">
                <span id="brush-hardness-value" class="ml-2 text-sm">100%</span>
            </div>
        </div>
        
        <div id="eraser-options" class="tool-options-content hidden">
            <label class="text-sm font-medium">Eraser Size</label>
            <input type="range" id="eraser-size" min="1" max="50" value="5" class="w-32">
            <span id="eraser-size-value" class="ml-2 text-sm">5px</span>
        </div>
        
        <div id="text-options" class="tool-options-content hidden">
            <input type="text" id="text-input" placeholder="Enter text" class="border rounded px-2 py-1 text-black w-40">
            <select id="font-family" class="ml-2 border rounded px-1">
                <option>Arial</option>
                <option>Helvetica</option>
                <option>Times New Roman</option>
                <option>Georgia</option>
            </select>
            <select id="font-size" class="ml-2 border rounded px-1">
                <option>12</option>
                <option>16</option>
                <option>24</option>
                <option>36</option>
                <option>48</option>
            </select>
        </div>
    </div>

    <script>
        // Photo Editor Application
        const app = {
            canvas: null,
            ctx: null,
            overlayCanvas: null,
            overlayCtx: null,
            currentTool: 'brush',
            isDrawing: false,
            lastX: 0,
            lastY: 0,
            primaryColor: '#000000',
            secondaryColor: '#FFFFFF',
            layers: [],
            activeLayer: 0,
            history: [],
            historyStep: -1,
            zoom: 1,
            adjustments: {
                brightness: 0,
                contrast: 0,
                hue: 0,
                saturation: 0
            },
            
            init() {
                this.canvas = document.getElementById('main-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.overlayCanvas = document.getElementById('overlay-canvas');
                this.overlayCtx = this.overlayCanvas.getContext('2d');
                
                // Initialize with a white background
                this.ctx.fillStyle = 'white';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Create initial layer
                this.addLayer();
                
                // Set up event listeners
                this.setupEventListeners();
                
                // Add initial history state
                this.saveHistory('New Document');
            },
            
            setupEventListeners() {
                // Canvas events
                this.canvas.addEventListener('mousedown', this.startDrawing.bind(this));
                this.canvas.addEventListener('mousemove', this.draw.bind(this));
                this.canvas.addEventListener('mouseup', this.stopDrawing.bind(this));
                this.canvas.addEventListener('mouseout', this.stopDrawing.bind(this));
                this.canvas.addEventListener('mousemove', this.updateCursorPosition.bind(this));
                
                // Tool buttons
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.selectTool(btn.dataset.tool);
                    });
                });
                
                // Color picker
                const colorPicker = document.getElementById('color-picker');
                colorPicker.addEventListener('change', (e) => {
                    this.primaryColor = e.target.value;
                    document.getElementById('primary-color').style.backgroundColor = e.target.value;
                    document.getElementById('hex-input').value = e.target.value;
                });
                
                const hexInput = document.getElementById('hex-input');
                hexInput.addEventListener('change', (e) => {
                    this.primaryColor = e.target.value;
                    document.getElementById('primary-color').style.backgroundColor = e.target.value;
                    colorPicker.value = e.target.value;
                });
                
                // Brush options
                const brushSize = document.getElementById('brush-size');
                brushSize.addEventListener('input', (e) => {
                    document.getElementById('brush-size-value').textContent = e.target.value + 'px';
                });
                
                const brushHardness = document.getElementById('brush-hardness');
                brushHardness.addEventListener('input', (e) => {
                    document.getElementById('brush-hardness-value').textContent = e.target.value + '%';
                });
                
                // Eraser options
                const eraserSize = document.getElementById('eraser-size');
                eraserSize.addEventListener('input', (e) => {
                    document.getElementById('eraser-size-value').textContent = e.target.value + 'px';
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', this.handleKeyboardShortcuts.bind(this));
            },
            
            selectTool(tool) {
                this.currentTool = tool;
                
                // Update UI
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('tool-active');
                });
                document.querySelector(`[data-tool="${tool}"]`).classList.add('tool-active');
                
                // Show/hide tool options
                document.querySelectorAll('.tool-options-content').forEach(el => {
                    el.classList.add('hidden');
                });
                
                const canvasContainer = document.getElementById('canvas-container');
                canvasContainer.className = '';
                
                if (tool === 'brush' || tool === 'eraser') {
                    document.getElementById(`${tool}-options`).classList.remove('hidden');
                    document.getElementById('tool-options').classList.remove('hidden');
                } else if (tool === 'text') {
                    document.getElementById('text-options').classList.remove('hidden');
                    document.getElementById('tool-options').classList.remove('hidden');
                } else {
                    document.getElementById('tool-options').classList.add('hidden');
                }
                
                // Update cursor
                if (tool === 'eyedropper') {
                    canvasContainer.classList.add('eyedropper-tool');
                } else if (tool === 'hand') {
                    canvasContainer.classList.add('hand-tool');
                } else if (tool === 'zoom') {
                    canvasContainer.classList.add('zoom-tool');
                }
            },
            
            startDrawing(e) {
                if (this.currentTool === 'eyedropper') {
                    this.pickColor(e);
                    return;
                }
                
                this.isDrawing = true;
                const rect = this.canvas.getBoundingClientRect();
                this.lastX = e.clientX - rect.left;
                this.lastY = e.clientY - rect.top;
                
                if (this.currentTool === 'text') {
                    this.addText(this.lastX, this.lastY);
                    return;
                }
                
                if (this.currentTool === 'rect' || this.currentTool === 'lasso') {
                    // Initialize selection
                    this.startX = this.lastX;
                    this.startY = this.lastY;
                }
            },
            
            draw(e) {
                if (!this.isDrawing) return;
                
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (this.currentTool === 'brush') {
                    this.drawBrush(x, y);
                } else if (this.currentTool === 'eraser') {
                    this.drawEraser(x, y);
                } else if (this.currentTool === 'rect' || this.currentTool === 'lasso') {
                    this.drawSelection(x, y);
                }
                
                this.lastX = x;
                this.lastY = y;
            },
            
            stopDrawing() {
                if (this.isDrawing) {
                    this.isDrawing = false;
                    this.saveHistory(`${this.currentTool} tool used`);
                }
            },
            
            drawBrush(x, y) {
                const size = document.getElementById('brush-size').value;
                const hardness = document.getElementById('brush-hardness').value;
                
                this.ctx.globalCompositeOperation = 'source-over';
                this.ctx.strokeStyle = this.primaryColor;
                this.ctx.lineWidth = size;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                
                this.ctx.beginPath();
                this.ctx.moveTo(this.lastX, this.lastY);
                this.ctx.lineTo(x, y);
                this.ctx.stroke();
            },
            
            drawEraser(x, y) {
                const size = document.getElementById('eraser-size').value;
                
                this.ctx.globalCompositeOperation = 'destination-out';
                this.ctx.lineWidth = size;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                
                this.ctx.beginPath();
                this.ctx.moveTo(this.lastX, this.lastY);
                this.ctx.lineTo(x, y);
                this.ctx.stroke();
                
                this.ctx.globalCompositeOperation = 'source-over';
            },
            
            drawSelection(x, y) {
                this.overlayCtx.clearRect(0, 0, this.overlayCanvas.width, this.overlayCanvas.height);
                
                if (this.currentTool === 'rect') {
                    this.overlayCtx.strokeStyle = '#0000FF';
                    this.overlayCtx.lineWidth = 1;
                    this.overlayCtx.setLineDash([5, 5]);
                    
                    const width = x - this.startX;
                    const height = y - this.startY;
                    
                    this.overlayCtx.strokeRect(this.startX, this.startY, width, height);
                    this.overlayCtx.setLineDash([]);
                }
            },
            
            addText(x, y) {
                const text = document.getElementById('text-input').value;
                if (!text) return;
                
                const fontSize = document.getElementById('font-size').value;
                const fontFamily = document.getElementById('font-family').value;
                
                this.ctx.font = `${fontSize}px ${fontFamily}`;
                this.ctx.fillStyle = this.primaryColor;
                this.ctx.fillText(text, x, y);
                
                this.saveHistory(`Added text: "${text}"`);
            },
            
            pickColor(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = Math.floor(e.clientX - rect.left);
                const y = Math.floor(e.clientY - rect.top);
                
                const pixel = this.ctx.getImageData(x, y, 1, 1).data;
                const hex = '#' + ('000000' + this.rgbToHex(pixel[0], pixel[1], pixel[2])).slice(-6);
                
                this.primaryColor = hex;
                document.getElementById('primary-color').style.backgroundColor = hex;
                document.getElementById('color-picker').value = hex;
                document.getElementById('hex-input').value = hex;
            },
            
            rgbToHex(r, g, b) {
                return ((r << 16) | (g << 8) | b).toString(16);
            },
            
            updateCursorPosition(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = Math.floor(e.clientX - rect.left);
                const y = Math.floor(e.clientY - rect.top);
                document.getElementById('cursor-position').textContent = `X: ${x}, Y: ${y}`;
            },
            
            addLayer() {
                const layerId = Date.now();
                const layer = {
                    id: layerId,
                    name: `Layer ${this.layers.length + 1}`,
                    visible: true,
                    opacity: 100,
                    blendMode: 'normal'
                };
                
                this.layers.push(layer);
                this.activeLayer = this.layers.length - 1;
                this.updateLayersPanel();
                this.saveHistory(`Added layer: ${layer.name}`);
            },
            
            deleteLayer() {
                if (this.layers.length <= 1) return;
                
                const deletedLayer = this.layers.splice(this.activeLayer, 1)[0];
                this.activeLayer = Math.min(this.activeLayer, this.layers.length - 1);
                this.updateLayersPanel();
                this.saveHistory(`Deleted layer: ${deletedLayer.name}`);
            },
            
            updateLayersPanel() {
                const layersList = document.getElementById('layers-list');
                layersList.innerHTML = '';
                
                this.layers.slice().reverse().forEach((layer, index) => {
                    const actualIndex = this.layers.length - 1 - index;
                    const layerEl = document.createElement('div');
                    layerEl.className = `p-2 bg-gray-50 rounded border flex items-center justify-between ${actualIndex === this.activeLayer ? 'layer-active' : ''}`;
                    layerEl.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <button class="w-5 h-5 flex items-center justify-center" onclick="app.toggleLayerVisibility(${actualIndex})">
                                <i class="fas ${layer.visible ? 'fa-eye' : 'fa-eye-slash'} text-xs"></i>
                            </button>
                            <span class="text-sm">${layer.name}</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <select class="text-xs border rounded px-1" onchange="app.updateLayerBlendMode(${actualIndex}, this.value)">
                                <option value="normal" ${layer.blendMode === 'normal' ? 'selected' : ''}>Normal</option>
                                <option value="multiply" ${layer.blendMode === 'multiply' ? 'selected' : ''}>Multiply</option>
                                <option value="screen" ${layer.blendMode === 'screen' ? 'selected' : ''}>Screen</option>
                                <option value="overlay" ${layer.blendMode === 'overlay' ? 'selected' : ''}>Overlay</option>
                                <option value="soft-light" ${layer.blendMode === 'soft-light' ? 'selected' : ''}>Soft Light</option>
                                <option value="hard-light" ${layer.blendMode === 'hard-light' ? 'selected' : ''}>Hard Light</option>
                                <option value="color-dodge" ${layer.blendMode === 'color-dodge' ? 'selected' : ''}>Color Dodge</option>
                                <option value="color-burn" ${layer.blendMode === 'color-burn' ? 'selected' : ''}>Color Burn</option>
                            </select>
                            <button class="w-5 h-5 flex items-center justify-center hover:bg-gray-200 rounded" onclick="app.selectLayer(${actualIndex})">
                                <i class="fas fa-check text-xs ${actualIndex === this.activeLayer ? 'visible' : 'invisible'}"></i>
                            </button>
                        </div>
                    `;
                    layersList.appendChild(layerEl);
                });
            },
            
            toggleLayerVisibility(index) {
                this.layers[index].visible = !this.layers[index].visible;
                this.updateLayersPanel();
                this.saveHistory(`${this.layers[index].visible ? 'Show' : 'Hide'} layer: ${this.layers[index].name}`);
            },
            
            updateLayerBlendMode(index, blendMode) {
                this.layers[index].blendMode = blendMode;
                this.saveHistory(`Changed blend mode: ${this.layers[index].name} to ${blendMode}`);
            },
            
            selectLayer(index) {
                this.activeLayer = index;
                this.updateLayersPanel();
            },
            
            applyAdjustment(type, value) {
                this.adjustments[type] = parseFloat(value);
                document.getElementById(`${type}-value`).textContent = value;
                this.applyImageAdjustments();
                this.saveHistory(`Applied ${type}: ${value}`);
            },
            
            applyImageAdjustments() {
                // This is a simplified version - in a real app, you'd apply filters to the image data
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                const data = imageData.data;
                
                // Apply brightness and contrast
                const brightness = this.adjustments.brightness;
                const contrast = (this.adjustments.contrast + 100) / 100;
                
                for (let i = 0; i < data.length; i += 4) {
                    // Apply brightness
                    data[i] += brightness;     // R
                    data[i + 1] += brightness; // G
                    data[i + 2] += brightness; // B
                    
                    // Apply contrast
                    data[i] = ((data[i] - 128) * contrast) + 128;
                    data[i + 1] = ((data[i + 1] - 128) * contrast) + 128;
                    data[i + 2] = ((data[i + 2] - 128) * contrast) + 128;
                    
                    // Clamp values
                    data[i] = Math.max(0, Math.min(255, data[i]));
                    data[i + 1] = Math.max(0, Math.min(255, data[i + 1]));
                    data[i + 2] = Math.max(0, Math.min(255, data[i + 2]));
                }
                
                this.ctx.putImageData(imageData, 0, 0);
            },
            
            resetAdjustments() {
                Object.keys(this.adjustments).forEach(key => {
                    this.adjustments[key] = 0;
                    const slider = document.getElementById(key);
                    if (slider) {
                        slider.value = 0;
                        document.getElementById(`${key}-value`).textContent = '0';
                    }
                });
                this.saveHistory('Reset adjustments');
            },
            
            applyFilter(filterType) {
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                const data = imageData.data;
                
                switch (filterType) {
                    case 'grayscale':
                        for (let i = 0; i < data.length; i += 4) {
                            const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                            data[i] = gray;
                            data[i + 1] = gray;
                            data[i + 2] = gray;
                        }
                        break;
                    
                    case 'sepia':
                        for (let i = 0; i < data.length; i += 4) {
                            const r = data[i];
                            const g = data[i + 1];
                            const b = data[i + 2];
                            
                            data[i] = Math.min(255, (r * 0.393) + (g * 0.769) + (b * 0.189));
                            data[i + 1] = Math.min(255, (r * 0.349) + (g * 0.686) + (b * 0.168));
                            data[i + 2] = Math.min(255, (r * 0.272) + (g * 0.534) + (b * 0.131));
                        }
                        break;
                    
                    case 'invert':
                        for (let i = 0; i < data.length; i += 4) {
                            data[i] = 255 - data[i];
                            data[i + 1] = 255 - data[i + 1];
                            data[i + 2] = 255 - data[i + 2];
                        }
                        break;
                    
                    case 'blur':
                        // Simple box blur - not optimized
                        const tempData = new Uint8ClampedArray(data);
                        const width = this.canvas.width;
                        const height = this.canvas.height;
                        
                        for (let y = 1; y < height - 1; y++) {
                            for (let x = 1; x < width - 1; x++) {
                                const idx = (y * width + x) * 4;
                                
                                for (let c = 0; c < 3; c++) {
                                    let sum = 0;
                                    for (let ky = -1; ky <= 1; ky++) {
                                        for (let kx = -1; kx <= 1; kx++) {
                                            const kidx = ((y + ky) * width + (x + kx)) * 4 + c;
                                            sum += tempData[kidx];
                                        }
                                    }
                                    data[idx + c] = sum / 9;
                                }
                            }
                        }
                        break;
                }
                
                this.ctx.putImageData(imageData, 0, 0);
                this.saveHistory(`Applied filter: ${filterType}`);
            },
            
            saveHistory(action) {
                // Save canvas state
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                
                // Remove any history after current step
                this.history = this.history.slice(0, this.historyStep + 1);
                
                // Add new history entry
                this.history.push({
                    action: action,
                    imageData: imageData,
                    timestamp: new Date().toLocaleTimeString()
                });
                
                this.historyStep++;
                
                // Update history panel
                this.updateHistoryPanel();
            },
            
            updateHistoryPanel() {
                const historyList = document.getElementById('history-list');
                historyList.innerHTML = '';
                
                this.history.forEach((entry, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = `px-3 py-2 bg-gray-700 rounded text-sm cursor-pointer history-item ${index === this.historyStep ? 'active' : ''}`;
                    historyItem.innerHTML = `
                        <div class="font-medium">${entry.action}</div>
                        <div class="text-xs opacity-75">${entry.timestamp}</div>
                    `;
                    historyItem.onclick = () => this.goToHistoryStep(index);
                    historyList.appendChild(historyItem);
                });
                
                // Scroll to active item
                if (historyList.children.length > 0) {
                    historyList.children[this.historyStep].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            },
            
            goToHistoryStep(step) {
                if (step < 0 || step >= this.history.length) return;
                
                this.historyStep = step;
                const imageData = this.history[step].imageData;
                this.ctx.putImageData(imageData, 0, 0);
                
                this.updateHistoryPanel();
            },
            
            undo() {
                if (this.historyStep > 0) {
                    this.goToHistoryStep(this.historyStep - 1);
                }
            },
            
            redo() {
                if (this.historyStep < this.history.length - 1) {
                    this.goToHistoryStep(this.historyStep + 1);
                }
            },
            
            newDocument() {
                this.ctx.fillStyle = 'white';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.layers = [];
                this.addLayer();
                this.saveHistory('New Document');
            },
            
            openImage(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Clear canvas
                        this.ctx.fillStyle = 'white';
                        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                        
                        // Calculate scaling to fit image
                        const scale = Math.min(this.canvas.width / img.width, this.canvas.height / img.height);
                        const x = (this.canvas.width - img.width * scale) / 2;
                        const y = (this.canvas.height - img.height * scale) / 2;
                        
                        // Draw image
                        this.ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                        this.saveHistory('Opened image');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            },
            
            saveImage() {
                const link = document.createElement('a');
                link.download = 'photo-editor-image.png';
                link.href = this.canvas.toDataURL();
                link.click();
                this.saveHistory('Saved image');
            },
            
            switchTab(tab) {
                // Update tab appearance
                document.querySelectorAll('.flex.border-b button').forEach(btn => {
                    btn.classList.remove('bg-white', 'border-b-2', 'border-blue-500');
                    btn.classList.add('hover:bg-gray-100');
                });
                
                event.target.classList.add('bg-white', 'border-b-2', 'border-blue-500');
                event.target.classList.remove('hover:bg-gray-100');
                
                // Show/hide panels
                document.getElementById('layers-panel').classList.add('hidden');
                document.getElementById('adjustments-panel').classList.add('hidden');
                document.getElementById('filters-panel').classList.add('hidden');
                
                document.getElementById(`${tab}-panel`).classList.remove('hidden');
            },
            
            handleKeyboardShortcuts(e) {
                // Ctrl/Cmd + Z: Undo
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    e.preventDefault();
                    this.undo();
                }
                
                // Ctrl/Cmd + Y: Redo
                if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                    e.preventDefault();
                    this.redo();
                }
                
                // Ctrl/Cmd + S: Save
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    this.saveImage();
                }
                
                // Tool shortcuts
                switch (e.key.toLowerCase()) {
                    case 'v':
                        this.selectTool('move');
                        break;
                    case 'b':
                        this.selectTool('brush');
                        break;
                    case 'e':
                        this.selectTool('eraser');
                        break;
                    case 'i':
                        this.selectTool('eyedropper');
                        break;
                    case 't':
                        this.selectTool('text');
                        break;
                    case 'm':
                        this.selectTool('rect');
                        break;
                    case 'l':
                        this.selectTool('lasso');
                        break;
                    case 'w':
                        this.selectTool('magicwand');
                        break;
                    case 'z':
                        this.selectTool('zoom');
                        break;
                    case 'h':
                        this.selectTool('hand');
                        break;
                    case 's':
                        this.selectTool('clonestamp');
                        break;
                    case 'p':
                        this.selectTool('pencil');
                        break;
                }
                
                // Ctrl/Cmd + +: Zoom in
                if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '=')) {
                    e.preventDefault();
                    this.zoom = Math.min(this.zoom * 1.1, 5);
                    this.updateZoom();
                }
                
                // Ctrl/Cmd + -: Zoom out
                if ((e.ctrlKey || e.metaKey) && e.key === '-') {
                    e.preventDefault();
                    this.zoom = Math.max(this.zoom / 1.1, 0.1);
                    this.updateZoom();
                }
                
                // Ctrl/Cmd + 0: Reset zoom
                if ((e.ctrlKey || e.metaKey) && e.key === '0') {
                    e.preventDefault();
                    this.zoom = 1;
                    this.updateZoom();
                }
            },
            
            updateZoom() {
                const canvasContainer = document.getElementById('canvas-container');
                canvasContainer.style.transform = `scale(${this.zoom})`;
                document.getElementById('zoom-level').textContent = `${Math.round(this.zoom * 100)}%`;
            }
        };
        
        // Initialize the app when the page loads
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>