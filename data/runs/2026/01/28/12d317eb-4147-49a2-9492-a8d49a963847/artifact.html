<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive 3D Earth Experience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Inter', sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        /* Custom scrollbar for the info panel */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(56, 189, 248, 0.5); border-radius: 3px; }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 50; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: opacity 1s ease-out;
        }
        
        .fade-out { opacity: 0; pointer-events: none; }
    </style>
    
    <!-- Import Map for Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body class="text-white antialiased">

    <!-- Loading Screen -->
    <div id="loader" class="loading-overlay">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-light tracking-widest text-blue-400">INITIALIZING ORBITAL DATA...</h2>
    </div>

    <!-- UI Overlay -->
    <div class="absolute top-0 left-0 w-full h-full pointer-events-none z-10 flex flex-col justify-between p-6">
        
        <!-- Header -->
        <header class="pointer-events-auto">
            <h1 class="text-4xl font-bold tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300 drop-shadow-lg">
                EARTH OS
            </h1>
            <p class="text-sm text-slate-400 mt-1">Interactive Planetary Model v1.0</p>
        </header>

        <!-- Info Popup (Hidden by default) -->
        <div id="info-panel" class="pointer-events-auto absolute top-1/2 right-6 transform -translate-y-1/2 translate-x-full transition-transform duration-500 ease-out w-80 glass-panel rounded-xl p-6 opacity-0">
            <div class="flex justify-between items-start mb-4">
                <h2 id="loc-title" class="text-2xl font-bold text-cyan-300">Location Name</h2>
                <button id="close-btn" class="text-slate-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div class="flex items-center space-x-3 text-sm text-slate-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span id="loc-coords">Lat: 00.00, Lng: 00.00</span>
                </div>
                <p id="loc-desc" class="text-slate-300 leading-relaxed text-sm custom-scroll max-h-40 overflow-y-auto">
                    Description text goes here.
                </p>
                <div class="pt-4 border-t border-slate-700">
                    <div class="flex justify-between text-xs text-slate-500 uppercase tracking-wider">
                        <span>Population</span>
                        <span id="loc-pop" class="text-white">Unknown</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="pointer-events-auto self-center glass-panel px-6 py-3 rounded-full text-sm text-slate-300 flex items-center gap-4 animate-bounce-slight">
            <span class="flex items-center gap-2"><span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span> Click markers to explore</span>
            <span class="h-4 w-px bg-slate-600"></span>
            <span class="flex items-center gap-2">Drag to rotate</span>
        </div>
    </div>

    <!-- 3D Canvas Container -->
    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- Configuration ---
        const TEXTURE_PATH = 'https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/';
        
        // --- State ---
        let scene, camera, renderer, controls;
        let earthMesh, atmosphereMesh, starMesh;
        let markers = [];
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        let isRotating = true;
        let activeMarker = null;

        // --- Data: Major Cities/Locations ---
        const locations = [
            {
                name: "New York City",
                lat: 40.7128,
                lon: -74.0060,
                pop: "8.8 Million",
                desc: "The most populous city in the United States, known for its iconic skyline, Central Park, and as a global hub for finance and culture."
            },
            {
                name: "London",
                lat: 51.5074,
                lon: -0.1278,
                pop: "8.9 Million",
                desc: "The capital of England and the United Kingdom, a 21st-century city with history stretching back to Roman times."
            },
            {
                name: "Tokyo",
                lat: 35.6762,
                lon: 139.6503,
                pop: "13.9 Million",
                desc: "Japan's busy capital, mixes the ultramodern and the traditional, from neon-lit skyscrapers to historic temples."
            },
            {
                name: "Sydney",
                lat: -33.8688,
                lon: 151.2093,
                pop: "5.3 Million",
                desc: "Capital of New South Wales and one of Australia's largest cities, best known for its harbourfront Sydney Opera House."
            },
            {
                name: "Rio de Janeiro",
                lat: -22.9068,
                lon: -43.1729,
                pop: "6.7 Million",
                desc: "A huge seaside city in Brazil, famed for its Copacabana and Ipanema beaches and Christ the Redeemer statue."
            },
            {
                name: "Cairo",
                lat: 30.0444,
                lon: 31.2357,
                pop: "9.9 Million",
                desc: "Egypt’s sprawling capital, set on the Nile River. At its heart is Tahrir Square and the vast Egyptian Museum."
            },
            {
                name: "Cape Town",
                lat: -33.9249,
                lon: 18.4241,
                pop: "4.6 Million",
                desc: "A port city on South Africa’s southwest coast, on a peninsula beneath the imposing Table Mountain."
            },
            {
                name: "Singapore",
                lat: 1.3521,
                lon: 103.8198,
                pop: "5.6 Million",
                desc: "An island city-state off southern Malaysia, a global financial center with a tropical climate and multicultural population."
            }
        ];

        // --- Initialization ---
        function init() {
            const container = document.getElementById('canvas-container');

            // Scene
            scene = new THREE.Scene();
            // Create a subtle gradient background using a large sphere or just color
            scene.background = new THREE.Color(0x020205);

            // Camera
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 22; // Initial zoom
            camera.position.y = 8;

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            // Tone mapping for realistic lighting falloff
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            container.appendChild(renderer.domElement);

            // Controls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enablePan = false;
            controls.minDistance = 12;
            controls.maxDistance = 35;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.8;

            // Lighting
            setupLighting();

            // Objects
            createStars();
            createEarth();
            createAtmosphere();
            createMarkers();

            // Event Listeners
            window.addEventListener('resize', onWindowResize);
            window.addEventListener('click', onMouseClick);

            // Remove Loader
            setTimeout(() => {
                document.getElementById('loader').classList.add('fade-out');
            }, 1500);

            animate();
        }

        function setupLighting() {
            const ambientLight = new THREE.AmbientLight(0x333333, 0.5); // Soft white light
            scene.add(ambientLight);

            const sunLight = new THREE.DirectionalLight(0xffffff, 2.5);
            sunLight.position.set(50, 20, 30);
            scene.add(sunLight);
            
            // Add a subtle backlight for atmosphere effect
            const backLight = new THREE.DirectionalLight(0x4455ff, 0.5);
            backLight.position.set(-20, 0, -20);
            scene.add(backLight);
        }

        function createStars() {
            const starGeometry = new THREE.BufferGeometry();
            const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.1, transparent: true, opacity: 0.8 });
            
            const starCount = 3000;
            const positions = new Float32Array(starCount * 3);
            
            for(let i = 0; i < starCount * 3; i++) {
                positions[i] = (Math.random() - 0.5) * 200; // Spread stars wide
            }
            
            starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            starMesh = new THREE.Points(starGeometry, starMaterial);
            scene.add(starMesh);
        }

        function createEarth() {
            const earthGroup = new THREE.Group();

            // 1. Base Sphere
            const geometry = new THREE.SphereGeometry(5, 64, 64);
            
            // Texture Loader
            const textureLoader = new THREE.TextureLoader();
            
            // Using reliable raw github paths for textures
            const earthMap = textureLoader.load(TEXTURE_PATH + 'earth_atmos_2048.jpg');
            const earthBump = textureLoader.load(TEXTURE_PATH + 'earth_normal_2048.jpg');
            const earthSpec = textureLoader.load(TEXTURE_PATH + 'earth_specular_2048.jpg');

            const material = new THREE.MeshPhongMaterial({
                map: earthMap,
                normalMap: earthBump,
                specularMap: earthSpec,
                specular: new THREE.Color(0x333333),
                shininess: 15
            });

            earthMesh = new THREE.Mesh(geometry, material);
            earthGroup.add(earthMesh);

            // 2. Wireframe Grid (Lat/Long lines simulation)
            const wireGeo = new THREE.WireframeGeometry(new THREE.SphereGeometry(5.05, 24, 24));
            const wireMat = new THREE.LineBasicMaterial({ color: 0x44aaff, transparent: true, opacity: 0.08 });
            const wireMesh = new THREE.LineSegments(wireGeo, wireMat);
            earthGroup.add(wireMesh);

            scene.add(earthGroup);
        }

        function createAtmosphere() {
            const vertexShader = `
                varying vec3 vNormal;
                void main() {
                    vNormal = normalize(normalMatrix * normal);
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `;

            const fragmentShader = `
                varying vec3 vNormal;
                void main() {
                    float intensity = pow(0.6 - dot(vNormal, vec3(0, 0, 1.0)), 4.0);
                    gl_FragColor = vec4(0.3, 0.6, 1.0, 1.0) * intensity;
                }
            `;

            const geometry = new THREE.SphereGeometry(5.2, 64, 64);
            const material = new THREE.ShaderMaterial({
                vertexShader: vertexShader,
                fragmentShader: fragmentShader,
                blending: THREE.AdditiveBlending,
                side: THREE.BackSide,
                transparent: true
            });

            atmosphereMesh = new THREE.Mesh(geometry, material);
            scene.add(atmosphereMesh);
        }

        function latLonToVector3(lat, lon, radius) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);

            const x = -(radius * Math.sin(phi) * Math.cos(theta));
            const z = (radius * Math.sin(phi) * Math.sin(theta));
            const y = (radius * Math.cos(phi));

            return new THREE.Vector3(x, y, z);
        }

        function createMarkers() {
            const geometry = new THREE.SphereGeometry(0.08, 16, 16);
            const material = new THREE.MeshBasicMaterial({ color: 0x00ffff });

            locations.forEach(loc => {
                const marker = new THREE.Mesh(geometry, material);
                const pos = latLonToVector3(loc.lat, loc.lon, 5.1); // Slightly above earth surface
                
                marker.position.copy(pos);
                marker.userData = { ...loc, isMarker: true }; // Store data for click
                
                // Add a glow sprite for the marker
                const spriteMat = new THREE.SpriteMaterial({ 
                    color: 0x00ffff, 
                    transparent: true, 
                    opacity: 0.6,
                    blending: THREE.AdditiveBlending
                });
                const sprite = new THREE.Sprite(spriteMat);
                sprite.scale.set(0.6, 0.6, 0.6);
                marker.add(sprite);

                scene.add(marker);
                markers.push(marker);
            });
        }

        // --- Interaction ---
        function onMouseClick(event) {
            // Calculate mouse position in normalized device coordinates
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            const intersects = raycaster.intersectObjects(markers);

            if (intersects.length > 0) {
                const object = intersects[0].object;
                selectMarker(object);
            } else {
                // Check if clicked on empty space to close panel
                const panel = document.getElementById('info-panel');
                if (!panel.contains(event.target) && !event.target.closest('#close-btn')) {
                    closeInfoPanel();
                }
            }
        }

        function selectMarker(marker) {
            activeMarker = marker;
            
            // Visual feedback
            markers.forEach(m => {
                m.material.color.setHex(0x00ffff);
                m.scale.set(1,1,1);
            });
            marker.material.color.setHex(0xff0055); // Highlight red
            marker.scale.set(1.5, 1.5, 1.5);

            // Update UI
            const data = marker.userData;
            document.getElementById('loc-title').textContent = data.name;
            document.getElementById('loc-coords').textContent = `Lat: ${data.lat}, Lng: ${data.lon}`;
            document.getElementById('loc-desc').textContent = data.desc;
            document.getElementById('loc-pop').textContent = data.pop;

            showInfoPanel();
            
            // Stop rotation when interacting
            controls.autoRotate = false;
        }

        function showInfoPanel() {
            const panel = document.getElementById('info-panel');
            panel.classList.remove('translate-x-full', 'opacity-0');
        }

        function closeInfoPanel() {
            const panel = document.getElementById('info-panel');
            panel.classList.add('translate-x-full', 'opacity-0');
            
            // Reset markers
            if(activeMarker) {
                activeMarker.material.color.setHex(0x00ffff);
                activeMarker.scale.set(1,1,1);
                activeMarker = null;
            }

            controls.autoRotate = true;
        }

        document.getElementById('close-btn').addEventListener('click', closeInfoPanel);

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);

            controls.update();
            
            // Animate markers (pulse effect)
            const time = Date.now() * 0.002;
            markers.forEach((marker, i) => {
                if(marker !== activeMarker) {
                    const scale = 1 + Math.sin(time + i) * 0.2;
                    marker.children[0].scale.set(scale * 0.6, scale * 0.6, scale * 0.6); // Scale the sprite
                }
            });

            // Slowly rotate stars
            if(starMesh) {
                starMesh.rotation.y += 0.0002;
            }

            renderer.render(scene, camera);
        }

        // Start
        init();

    </script>
</body>
</html>