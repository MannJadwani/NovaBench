<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velocit - Professional Video Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #18181b; /* Zinc 900 */
            color: #e4e4e7; /* Zinc 200 */
            overflow: hidden; /* App-like feel */
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #27272a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #3f3f46; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #52525b; 
        }

        /* Timeline Grid Pattern */
        .timeline-grid {
            background-image: linear-gradient(to right, #27272a 1px, transparent 1px);
            background-size: 50px 100%;
        }

        .clip-block {
            transition: transform 0.1s, box-shadow 0.1s;
            cursor: grab;
        }
        .clip-block:active {
            cursor: grabbing;
        }
        .clip-block.selected {
            outline: 2px solid #3b82f6;
            z-index: 10;
        }

        .range-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 6px;
            background-color: #facc15;
            cursor: col-resize;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .clip-block:hover .range-handle {
            opacity: 1;
        }
        .range-handle.left { left: 0; }
        .range-handle.right { right: 0; }

        /* Playhead Animation */
        #playhead {
            pointer-events: none;
            z-index: 50;
            transition: left 0.1s linear; /* Smooth scrubbing */
        }
        
        /* Keyframe Curve Editor Canvas */
        canvas#keyframe-editor {
            background: #18181b;
            border-top: 1px solid #3f3f46;
        }
    </style>
</head>
<body class="h-screen flex flex-col text-sm select-none">

    <!-- Top Navigation / Toolbar -->
    <header class="h-14 bg-zinc-900 border-b border-zinc-800 flex items-center justify-between px-4 shrink-0 z-20">
        <div class="flex items-center space-x-4">
            <div class="flex items-center text-blue-500 font-bold text-xl tracking-tight">
                <i class="fa-solid fa-bolt mr-2"></i> VELOCIT
            </div>
            <nav class="hidden md:flex space-x-1 text-zinc-400">
                <button class="px-3 py-1 hover:text-white hover:bg-zinc-800 rounded">File</button>
                <button class="px-3 py-1 hover:text-white hover:bg-zinc-800 rounded">Edit</button>
                <button class="px-3 py-1 hover:text-white hover:bg-zinc-800 rounded">View</button>
                <button class="px-3 py-1 hover:text-white hover:bg-zinc-800 rounded">Export</button>
            </nav>
        </div>

        <!-- Transport Controls -->
        <div class="flex items-center space-x-4 bg-zinc-800 px-4 py-1 rounded-full border border-zinc-700">
            <button class="text-zinc-400 hover:text-white"><i class="fa-solid fa-backward-step"></i></button>
            <button id="play-pause-btn" class="text-white hover:text-blue-400 text-lg w-6"><i class="fa-solid fa-play"></i></button>
            <button class="text-zinc-400 hover:text-white"><i class="fa-solid fa-forward-step"></i></button>
            <div class="h-4 w-px bg-zinc-600 mx-2"></div>
            <span id="time-display" class="font-mono text-xs text-zinc-300">00:00:00:00</span>
        </div>

        <div class="flex items-center space-x-3">
            <button class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded text-xs font-medium transition" onclick="toggleExportModal()">
                <i class="fa-solid fa-share-from-square mr-1"></i> Export
            </button>
            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-500 to-blue-500 border border-zinc-600"></div>
        </div>
    </header>

    <!-- Main Workspace -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- LEFT SIDEBAR: Media & Effects -->
        <aside class="w-72 bg-zinc-900 border-r border-zinc-800 flex flex-col shrink-0 z-10">
            <!-- Tabs -->
            <div class="flex border-b border-zinc-800">
                <button class="flex-1 py-3 text-xs font-medium text-blue-400 border-b-2 border-blue-500 bg-zinc-800/50">Media</button>
                <button class="flex-1 py-3 text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800/30 transition">Effects</button>
                <button class="flex-1 py-3 text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800/30 transition">Audio</button>
            </div>

            <!-- Media Library Content -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                
                <!-- Import Area -->
                <div class="border-2 border-dashed border-zinc-700 rounded-lg p-4 text-center hover:border-blue-500 hover:bg-zinc-800/50 transition cursor-pointer group" onclick="document.getElementById('file-upload').click()">
                    <input type="file" id="file-upload" class="hidden" accept="video/*,audio/*,image/*" multiple>
                    <i class="fa-solid fa-cloud-arrow-up text-2xl text-zinc-500 group-hover:text-blue-400 mb-2 transition"></i>
                    <p class="text-xs text-zinc-400">Import Media</p>
                </div>

                <!-- Project Files List -->
                <div>
                    <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-wider mb-3">Project Files</h3>
                    <div id="media-list" class="space-y-2">
                        <!-- Generated via JS -->
                    </div>
                </div>

                <!-- Transitions -->
                <div>
                    <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-wider mb-3 mt-6">Transitions</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-zinc-800 p-2 rounded text-center cursor-pointer hover:bg-zinc-700 border border-transparent hover:border-blue-500 transition">
                            <div class="h-8 bg-gradient-to-r from-black via-zinc-500 to-transparent mb-1 rounded-sm"></div>
                            <span class="text-[10px]">Fade</span>
                        </div>
                        <div class="bg-zinc-800 p-2 rounded text-center cursor-pointer hover:bg-zinc-700 border border-transparent hover:border-blue-500 transition">
                            <div class="h-8 flex items-center justify-center bg-zinc-700 mb-1 rounded-sm"><i class="fa-solid fa-arrows-left-right text-zinc-400"></i></div>
                            <span class="text-[10px]">Wipe</span>
                        </div>
                        <div class="bg-zinc-800 p-2 rounded text-center cursor-pointer hover:bg-zinc-700 border border-transparent hover:border-blue-500 transition">
                            <div class="h-8 flex items-center justify-center bg-zinc-700 mb-1 rounded-sm"><i class="fa-solid fa-rotate text-zinc-400"></i></div>
                            <span class="text-[10px]">Spin</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- CENTER: Preview & Timeline -->
        <main class="flex-1 flex flex-col min-w-0 bg-zinc-950 relative">
            
            <!-- Preview Area -->
            <div class="flex-1 flex items-center justify-center bg-black relative overflow-hidden group">
                <!-- Video Canvas/Element -->
                <div id="video-container" class="relative w-full h-full max-w-5xl max-h-[70vh] bg-zinc-900 flex items-center justify-center shadow-2xl overflow-hidden m-4 rounded border border-zinc-800">
                    <!-- Placeholder content when no video is playing -->
                    <div id="placeholder-content" class="text-center">
                        <i class="fa-solid fa-film text-6xl text-zinc-800 mb-4"></i>
                        <p class="text-zinc-600 font-medium">No Preview Available</p>
                    </div>
                    <!-- Actual Video Element (Hidden until loaded) -->
                    <video id="main-video" class="hidden w-full h-full object-contain" loop></video>
                    
                    <!-- Overlays (Safe zones, etc) -->
                    <div class="absolute inset-0 pointer-events-none border-[1px] border-white/10 m-12 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                </div>

                <!-- Preview Controls Overlay -->
                <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-black/80 backdrop-blur px-4 py-2 rounded-lg flex items-center space-x-4 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button class="text-white/70 hover:text-white" title="Fit"><i class="fa-solid fa-compress"></i></button>
                    <select class="bg-transparent text-white/70 text-xs outline-none border-none">
                        <option>100%</option>
                        <option>Fit</option>
                        <option>Fill</option>
                    </select>
                    <div class="w-px h-4 bg-white/20"></div>
                    <span class="text-xs text-white/50">Resolution: 1920x1080</span>
                </div>
            </div>

            <!-- Splitter (Visual only for this demo) -->
            <div class="h-1 bg-zinc-800 hover:bg-blue-500 cursor-ns-resize transition-colors shrink-0"></div>

            <!-- Timeline Area -->
            <div class="h-80 bg-zinc-900 flex flex-col shrink-0 border-t border-zinc-800">
                
                <!-- Timeline Toolbar -->
                <div class="h-8 bg-zinc-800 border-b border-zinc-700 flex items-center px-2 space-x-2 shrink-0">
                    <button class="text-zinc-400 hover:text-white p-1" title="Add Track"><i class="fa-solid fa-plus"></i></button>
                    <div class="w-px h-4 bg-zinc-600 mx-1"></div>
                    <button class="text-zinc-400 hover:text-white p-1" title="Snap"><i class="fa-solid fa-magnet"></i></button>
                    <button class="text-zinc-400 hover:text-white p-1" title="Marker"><i class="fa-solid fa-location-dot"></i></button>
                    <div class="flex-1"></div>
                    <div class="flex items-center space-x-1 bg-zinc-900 rounded px-2 py-0.5 border border-zinc-700">
                        <i class="fa-solid fa-magnifying-glass-minus text-[10px] text-zinc-500"></i>
                        <input type="range" min="20" max="200" value="50" class="w-24 h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer">
                        <i class="fa-solid fa-magnifying-glass-plus text-[10px] text-zinc-500"></i>
                    </div>
                </div>

                <!-- Tracks Container -->
                <div class="flex-1 flex overflow-hidden relative">
                    
                    <!-- Track Headers (Left) -->
                    <div class="w-48 bg-zinc-900 border-r border-zinc-800 flex flex-col shrink-0 z-10 shadow-lg" id="track-headers">
                        <!-- Generated via JS -->
                    </div>

                    <!-- Timeline Tracks (Right) -->
                    <div class="flex-1 overflow-x-auto overflow-y-hidden relative timeline-grid bg-zinc-950" id="timeline-scroll-area">
                        
                        <!-- Time Ruler -->
                        <div class="h-6 bg-zinc-900 border-b border-zinc-800 sticky top-0 z-20 flex text-[10px] text-zinc-500 select-none" id="time-ruler">
                            <!-- JS will populate ticks -->
                        </div>

                        <!-- Tracks Wrapper -->
                        <div class="relative h-full pt-6" id="tracks-container">
                            
                            <!-- Playhead -->
                            <div id="playhead" class="absolute top-0 bottom-0 w-px bg-red-500 left-0 transition-none">
                                <div class="w-3 h-3 bg-red-500 transform -translate-x-1/2 rotate-45 -mt-1.5 absolute top-0"></div>
                            </div>

                            <!-- Generated Tracks go here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- RIGHT SIDEBAR: Inspector & Keyframes -->
        <aside class="w-72 bg-zinc-900 border-l border-zinc-800 flex flex-col shrink-0 z-10">
            <!-- Inspector Header -->
            <div class="h-10 border-b border-zinc-800 flex items-center px-4 bg-zinc-800/50">
                <span class="text-xs font-bold text-zinc-300">Inspector</span>
            </div>

            <!-- Inspector Content -->
            <div class="flex-1 overflow-y-auto">
                <div id="inspector-empty" class="p-8 text-center text-zinc-500 text-xs">
                    Select a clip to edit properties.
                </div>

                <div id="inspector-content" class="hidden">
                    <!-- Transform Section -->
                    <div class="border-b border-zinc-800">
                        <button class="w-full px-4 py-3 flex justify-between items-center hover:bg-zinc-800/50 transition" onclick="toggleSection(this)">
                            <span class="text-xs font-bold text-zinc-300"><i class="fa-solid fa-up-right-and-down-left-from-center w-5"></i> Transform</span>
                            <i class="fa-solid fa-chevron-down text-[10px] text-zinc-500 transition-transform"></i>
                        </button>
                        <div class="px-4 pb-4 space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] text-zinc-500 block mb-1">Position X</label>
                                    <input type="number" value="0" class="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-xs text-zinc-300 focus:border-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="text-[10px] text-zinc-500 block mb-1">Position Y</label>
                                    <input type="number" value="0" class="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-xs text-zinc-300 focus:border-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="text-[10px] text-zinc-500 block mb-1">Scale</label>
                                    <input type="number" value="100" class="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-xs text-zinc-300 focus:border-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="text-[10px] text-zinc-500 block mb-1">Rotation</label>
                                    <input type="number" value="0" class="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-xs text-zinc-300 focus:border-blue-500 outline-none">
                                </div>
                            </div>
                            <!-- Opacity -->
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-[10px] text-zinc-500">Opacity</label>
                                    <span class="text-[10px] text-zinc-400">100%</span>
                                </div>
                                <input type="range" min="0" max="100" value="100" class="w-full h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                    </div>

                    <!-- Video Section -->
                    <div class="border-b border-zinc-800">
                        <button class="w-full px-4 py-3 flex justify-between items-center hover:bg-zinc-800/50 transition" onclick="toggleSection(this)">
                            <span class="text-xs font-bold text-zinc-300"><i class="fa-solid fa-video w-5"></i> Video</span>
                            <i class="fa-solid fa-chevron-down text-[10px] text-zinc-500 transition-transform"></i>
                        </button>
                        <div class="px-4 pb-4 space-y-3 hidden">
                             <div>
                                <label class="text-[10px] text-zinc-500 block mb-1">Speed</label>
                                <div class="flex items-center bg-zinc-800 rounded border border-zinc-700">
                                    <button class="px-2 text-zinc-400 hover:text-white"><i class="fa-solid fa-minus"></i></button>
                                    <input type="text" value="1.0x" class="w-full bg-transparent text-center text-xs py-1 outline-none">
                                    <button class="px-2 text-zinc-400 hover:text-white"><i class="fa-solid fa-plus"></i></button>
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] text-zinc-500 block mb-1">Blend Mode</label>
                                <select class="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-xs text-zinc-300 outline-none">
                                    <option>Normal</option>
                                    <option>Screen</option>
                                    <option>Multiply</option>
                                    <option>Overlay</option>
                                </select>
                            </div>
                        </div>
                    </div>

                     <!-- Color Correction Section -->
                     <div class="border-b border-zinc-800">
                        <button class="w-full px-4 py-3 flex justify-between items-center hover:bg-zinc-800/50 transition" onclick="toggleSection(this)">
                            <span class="text-xs font-bold text-zinc-300"><i class="fa-solid fa-palette w-5"></i> Color</span>
                            <i class="fa-solid fa-chevron-down text-[10px] text-zinc-500 transition-transform"></i>
                        </button>
                        <div class="px-4 pb-4 space-y-4 hidden">
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-[10px] text-zinc-500">Exposure</label>
                                </div>
                                <input type="range" class="w-full h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-[10px] text-zinc-500">Contrast</label>
                                </div>
                                <input type="range" class="w-full h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-[10px] text-zinc-500">Saturation</label>
                                </div>
                                <input type="range" class="w-full h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                    </div>

                    <!-- Keyframes -->
                    <div class="border-b border-zinc-800">
                         <button class="w-full px-4 py-3 flex justify-between items-center hover:bg-zinc-800/50 transition bg-zinc-800/30">
                            <span class="text-xs font-bold text-zinc-300"><i class="fa-solid fa-stopwatch w-5"></i> Keyframes</span>
                        </button>
                        <div class="h-32 w-full relative bg-zinc-950">
                            <canvas id="keyframe-editor" class="w-full h-full block"></canvas>
                            <div class="absolute top-2 left-2 text-[10px] text-zinc-500">Opacity</div>
                        </div>
                    </div>

                </div>
            </div>
        </aside>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-zinc-900 border border-zinc-700 rounded-lg w-96 shadow-2xl transform transition-all scale-95 opacity-0" id="export-modal-content">
            <div class="flex justify-between items-center p-4 border-b border-zinc-800">
                <h3 class="text-sm font-bold text-white">Export Video</h3>
                <button onclick="toggleExportModal()" class="text-zinc-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs text-zinc-400 mb-1">File Name</label>
                    <input type="text" value="My_Awesome_Video_v1" class="w-full bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-sm text-white outline-none focus:border-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-zinc-400 mb-1">Resolution</label>
                        <select class="w-full bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-sm text-white outline-none">
                            <option>1920 x 1080 (FHD)</option>
                            <option>3840 x 2160 (4K)</option>
                            <option>1280 x 720 (HD)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-zinc-400 mb-1">Format</label>
                        <select class="w-full bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-sm text-white outline-none">
                            <option>MP4 (H.264)</option>
                            <option>MOV (ProRes)</option>
                            <option>WebM</option>
                        </select>
                    </div>
                </div>
                
                <!-- Progress (Hidden initially) -->
                <div id="export-progress-container" class="hidden">
                    <div class="flex justify-between text-xs text-zinc-300 mb-1">
                        <span>Encoding...</span>
                        <span id="export-percent">0%</span>
                    </div>
                    <div class="w-full bg-zinc-800 rounded-full h-2">
                        <div id="export-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

            </div>
            <div class="p-4 border-t border-zinc-800 bg-zinc-900/50 flex justify-end space-x-2 rounded-b-lg">
                <button onclick="toggleExportModal()" class="px-4 py-2 text-xs font-medium text-zinc-300 hover:text-white hover:bg-zinc-800 rounded transition">Cancel</button>
                <button onclick="startExport()" class="px-4 py-2 text-xs font-medium bg-blue-600 hover:bg-blue-500 text-white rounded transition shadow-lg shadow-blue-900/20">Start Export</button>
            </div>
        </div>
    </div>

    <script>
        // --- Data & State ---
        const state = {
            clips: [
                { id: 'c1', trackId: 'v1', start: 0, duration: 120, name: 'Intro Shot', type: 'video', color: 'bg-blue-600' },
                { id: 'c2', trackId: 'v1', start: 125, duration: 240, name: 'Main Sequence', type: 'video', color: 'bg-blue-600' },
                { id: 'c3', trackId: 'a1', start: 0, duration: 400, name: 'Background Music', type: 'audio', color: 'bg-emerald-600' },
                { id: 'c4', trackId: 'v2', start: 130, duration: 100, name: 'Title Card', type: 'title', color: 'bg-purple-600' }
            ],
            media: [
                { id: 'm1', name: 'Drone_Footage.mp4', type: 'video', duration: '00:04:20' },
                { id: 'm2', name: 'Interview_Clip.mov', type: 'video', duration: '00:12:15' },
                { id: 'm3', name: 'Background_Beat.wav', type: 'audio', duration: '00:03:00' },
                { id: 'm4', name: 'Sound_Effect.mp3', type: 'audio', duration: '00:00:05' },
                { id: 'm5', name: 'Logo.png', type: 'image', duration: '-' }
            ],
            tracks: [
                { id: 'v2', type: 'video', name: 'Video 2', locked: false, hidden: false },
                { id: 'v1', type: 'video', name: 'Video 1', locked: false, hidden: false },
                { id: 'a1', type: 'audio', name: 'Audio 1', locked: false, hidden: false },
                { id: 'a2', type: 'audio', name: 'Audio 2', locked: false, hidden: false }
            ],
            zoom: 1,
            playhead: 0,
            isPlaying: false,
            playInterval: null,
            selectedClipId: null
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderMediaLibrary();
            renderTracks();
            renderRuler();
            initKeyframeCanvas();
            setupDragAndDrop();
        });

        // --- Rendering Functions ---

        function renderMediaLibrary() {
            const list = document.getElementById('media-list');
            list.innerHTML = state.media.map(m => `
                <div class="flex items-center p-2 bg-zinc-800/50 rounded border border-zinc-800 hover:bg-zinc-800 cursor-pointer group transition" draggable="true" ondragstart="dragMedia(event, '${m.id}')">
                    <div class="w-8 h-8 rounded bg-zinc-700 flex items-center justify-center mr-3 text-zinc-400 group-hover:text-white">
                        <i class="fa-solid ${m.type === 'video' ? 'fa-film' : m.type === 'audio' ? 'fa-music' : 'fa-image'}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs font-medium text-zinc-300 truncate">${m.name}</div>
                        <div class="text-[10px] text-zinc-500">${m.type.toUpperCase()} â€¢ ${m.duration}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderTracks() {
            const headers = document.getElementById('track-headers');
            const container = document.getElementById('tracks-container');
            
            headers.innerHTML = '';
            // Keep playhead
            const playhead = document.getElementById('playhead');
            container.innerHTML = '';
            container.appendChild(playhead);

            state.tracks.forEach(track => {
                // Header
                const headerHtml = `
                    <div class="h-16 border-b border-zinc-800 flex items-center px-3 bg-zinc-900">
                        <div class="w-6 text-zinc-500 cursor-pointer hover:text-white"><i class="fa-regular ${track.hidden ? 'fa-eye-slash' : 'fa-eye'}"></i></div>
                        <div class="w-6 text-zinc-500 cursor-pointer hover:text-white ml-2"><i class="fa-solid ${track.locked ? 'fa-lock' : 'fa-lock-open'}"></i></div>
                        <span class="ml-3 text-xs font-bold text-zinc-400 w-20 truncate">${track.name}</span>
                        <div class="ml-auto w-2 h-full ${track.type === 'video' ? 'bg-blue-900' : 'bg-emerald-900'}"></div>
                    </div>
                `;
                headers.insertAdjacentHTML('beforeend', headerHtml);

                // Timeline Track
                const trackEl = document.createElement('div');
                trackEl.className = 'h-16 border-b border-zinc-800 relative w-[2000px]'; // Fixed width for scroll
                trackEl.dataset.trackId = track.id;
                trackEl.ondrop = (e) => dropOnTrack(e, track.id);
                trackEl.ondragover = allowDrop;

                // Render Clips on this track
                state.clips.filter(c => c.trackId === track.id).forEach(clip => {
                    const left = clip.start * 2; // 1 unit = 2px
                    const width = clip.duration * 2;
                    
                    const clipEl = document.createElement('div');
                    clipEl.className = `clip-block absolute top-1 bottom-1 rounded overflow-hidden border border-white/10 shadow-sm select-none ${clip.color} ${clip.id === state.selectedClipId ? 'selected ring-2 ring-blue-500' : ''}`;
                    clipEl.style.left = `${left}px`;
                    clipEl.style.width = `${width}px`;
                    clipEl.innerHTML = `
                        <div class="px-2 py-1 text-[10px] font-bold text-white truncate drop-shadow-md">${clip.name}</div>
                        ${clip.type === 'audio' ? `<div class="absolute bottom-0 left-0 right-0 h-4 opacity-50" style="background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAiIHByZXNlcnZlQXNwZWN0UmF0aW89Im5vbmUiPjxwYXRoIGQ9Ik0wLDUgUTEwLDAgMjAsNSBUNDAsNSBUNjAsNSBUNDAsNSBUNjAsNSBUNDAsNSBUNzAsNSBUNDAsNSBUNjAsNSBUNDAsNSBUNzAsNSBUMCw1IiBmaWxsPSIjZmZmIiBmaWxsLW9wYWNpdHk9IjAuNSIvPjwvc3ZnPg=='); background-size: 50px 100%;"></div>` : ''}
                        <div class="range-handle left" onmousedown="startResize(event, '${clip.id}', 'left')"></div>
                        <div class="range-handle right" onmousedown="startResize(event, '${clip.id}', 'right')"></div>
                    `;
                    clipEl.onclick = (e) => {
                        e.stopPropagation();
                        selectClip(clip.id);
                    };
                    // Dragging
                    clipEl.draggable = true;
                    clipEl.ondragstart = (e) => {
                        e.dataTransfer.setData('clipId', clip.id);
                        e.dataTransfer.setData('offsetX', e.offsetX);
                    };

                    trackEl.appendChild(clipEl);
                });

                container.appendChild(trackEl);
            });
        }

        function renderRuler() {
            const ruler = document.getElementById('time-ruler');
            ruler.innerHTML = '';
            const totalDuration = 500; // seconds
            const pxPerSecond = 2;
            
            for(let i=0; i<=totalDuration; i+=10) {
                const tick = document.createElement('div');
                tick.className = 'absolute bottom-0 border-l border-zinc-700 h-2 text-[9px] pl-1';
                tick.style.left = `${i * pxPerSecond}px`;
                if (i % 30 === 0) {
                    tick.className = 'absolute bottom-0 border-l border-zinc-500 h-3 text-[9px] pl-1 font-mono';
                    const min = Math.floor(i/60).toString().padStart(2, '0');
                    const sec = (i%60).toString().padStart(2, '0');
                    tick.innerText = `${min}:${sec}`;
                }
                ruler.appendChild(tick);
            }
        }

        // --- Interaction Logic ---

        function selectClip(id) {
            state.selectedClipId = id;
            renderTracks();
            document.getElementById('inspector-empty').classList.add('hidden');
            document.getElementById('inspector-content').classList.remove('hidden');
            drawKeyframes(); // Refresh canvas
        }

        function dragMedia(ev, mediaId) {
            ev.dataTransfer.setData("mediaId", mediaId);
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function dropOnTrack(ev, trackId) {
            ev.preventDefault();
            const mediaId = ev.dataTransfer.getData("mediaId");
            const clipId = ev.dataTransfer.getData("clipId");
            
            if (mediaId) {
                const media = state.media.find(m => m.id === mediaId);
                const rect = ev.target.closest('[data-track-id]').getBoundingClientRect();
                const x = ev.clientX - rect.left;
                const startTime = Math.floor(x / 2); // 2px per frame/unit

                const newClip = {
                    id: 'c' + Date.now(),
                    trackId: trackId,
                    start: Math.max(0, startTime),
                    duration: 100, // Default duration
                    name: media.name.split('.')[0],
                    type: media.type,
                    color: media.type === 'audio' ? 'bg-emerald-600' : 'bg-blue-600'
                };
                state.clips.push(newClip);
                selectClip(newClip.id);
            } else if (clipId) {
                // Move clip
                const clip = state.clips.find(c => c.id === clipId);
                const rect = ev.target.closest('[data-track-id]').getBoundingClientRect();
                const offsetX = parseInt(ev.dataTransfer.getData('offsetX'));
                const x = ev.clientX - rect.left - offsetX;
                
                clip.trackId = trackId;
                clip.start = Math.max(0, Math.floor(x / 2));
                selectClip(clip.id);
            }
            renderTracks();
        }

        let resizingClip = null;
        let resizeDirection = null;
        let startX = 0;
        let startDuration = 0;
        let startStart = 0;

        function startResize(e, clipId, dir) {
            e.preventDefault();
            e.stopPropagation();
            resizingClip = state.clips.find(c => c.id === clipId);
            resizeDirection = dir;
            startX = e.clientX;
            startDuration = resizingClip.duration;
            startStart = resizingClip.start;
            
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
        }

        function doResize(e) {
            if (!resizingClip) return;
            const dx = (e.clientX - startX) / 2; // Convert px to time
            
            if (resizeDirection === 'right') {
                resizingClip.duration = Math.max(10, startDuration + dx);
            } else if (resizeDirection === 'left') {
                const newDuration = Math.max(10, startDuration - dx);
                const diff = startDuration - newDuration;
                resizingClip.start = startStart + diff;
                resizingClip.duration = newDuration;
            }
            renderTracks();
            // Keep selection
            state.selectedClipId = resizingClip.id; 
            document.querySelector(`[onclick="selectClip('${resizingClip.id}')"]`)?.classList.add('selected');
        }

        function stopResize() {
            resizingClip = null;
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
        }

        // --- Playback Logic ---
        const playBtn = document.getElementById('play-pause-btn');
        const playIcon = playBtn.querySelector('i');
        const timeDisplay = document.getElementById('time-display');
        const playhead = document.getElementById('playhead');

        playBtn.addEventListener('click', togglePlay);

        function togglePlay() {
            state.isPlaying = !state.isPlaying;
            if (state.isPlaying) {
                playIcon.className = 'fa-solid fa-pause';
                state.playInterval = setInterval(() => {
                    state.playhead += 0.5; // Move 0.5 units per tick
                    updatePlayhead();
                }, 50); // 20 ticks per second
            } else {
                playIcon.className = 'fa-solid fa-play';
                clearInterval(state.playInterval);
            }
        }

        function updatePlayhead() {
            const px = state.playhead * 2;
            playhead.style.left = `${px}px`;
            
            // Format time
            const totalSeconds = Math.floor(state.playhead / 30); // Assuming 30fps
            const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const s = (totalSeconds % 60).toString().padStart(2, '0');
            const f = Math.floor(state.playhead % 30).toString().padStart(2, '0');
            timeDisplay.innerText = `00:${m}:${s}:${f}`;

            // Auto scroll
            const container = document.getElementById('timeline-scroll-area');
            if (px > container.scrollLeft + container.clientWidth - 50) {
                container.scrollLeft = px - 50;
            }
        }

        // --- Inspector Logic ---
        function toggleSection(btn) {
            const content = btn.nextElementSibling;
            const arrow = btn.querySelector('.fa-chevron-down');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('hidden');
                arrow.style.transform = 'rotate(-90deg)';
            }
        }

        // --- Canvas Keyframe Editor ---
        function initKeyframeCanvas() {
            const canvas = document.getElementById('keyframe-editor');
            const resize = () => {
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
                drawKeyframes();
            };
            window.addEventListener('resize', resize);
            resize();
        }

        function drawKeyframes() {
            const canvas = document.getElementById('keyframe-editor');
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;
            
            ctx.clearRect(0, 0, w, h);
            
            // Grid
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for(let i=0; i<w; i+=20) { ctx.moveTo(i,0); ctx.lineTo(i,h); }
            for(let i=0; i<h; i+=20) { ctx.moveTo(0,i); ctx.lineTo(w,i); }
            ctx.stroke();

            // Draw a dummy curve
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, h);
            ctx.bezierCurveTo(w/3, h, w/1.5, 0, w, h/2);
            ctx.stroke();

            // Draw Keyframe points
            ctx.fillStyle = '#fff';
            [0, w].forEach(x => {
                ctx.beginPath();
                ctx.arc(x === 0 ? 10 : w-10, x === 0 ? h-10 : h/2, 4, 0, Math.PI*2);
                ctx.fill();
            });
        }

        // --- Export Logic ---
        function toggleExportModal() {
            const modal = document.getElementById('export-modal');
            const content = document.getElementById('export-modal-content');
            
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                // Small timeout for transition
                setTimeout(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                }, 10);
            } else {
                content.classList.remove('scale-100', 'opacity-100');
                content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 200);
            }
        }

        function startExport() {
            const progressContainer = document.getElementById('export-progress-container');
            const bar = document.getElementById('export-bar');
            const percent = document.getElementById('export-percent');
            
            progressContainer.classList.remove('hidden');
            
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        alert("Export Complete!");
                        toggleExportModal();
                        progressContainer.classList.add('hidden');
                        bar.style.width = '0%';
                    }, 500);
                } else {
                    width += Math.random() * 2;
                    if(width > 100) width = 100;
                    bar.style.width = width + '%';
                    percent.innerText = Math.floor(width) + '%';
                }
            }, 50);
        }

        // --- File Upload Logic ---
        document.getElementById('file-upload').addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                const newId = 'm' + (state.media.length + 1);
                state.media.unshift({
                    id: newId,
                    name: file.name,
                    type: file.type.startsWith('video') ? 'video' : 'audio',
                    duration: '00:00:10' // Mock duration
                });
                renderMediaLibrary();
                
                // Simulate adding to timeline immediately
                const newClip = {
                    id: 'c' + Date.now(),
                    trackId: 'v1',
                    start: 0,
                    duration: 150,
                    name: file.name.split('.')[0],
                    type: file.type.startsWith('video') ? 'video' : 'audio',
                    color: file.type.startsWith('video') ? 'bg-indigo-600' : 'bg-teal-600'
                };
                state.clips.push(newClip);
                renderTracks();
                selectClip(newClip.id);
            }
        });

        function setupDragAndDrop() {
            // Prevent default browser drag behaviors
            window.addEventListener('dragover', e => e.preventDefault());
            window.addEventListener('drop', e => e.preventDefault());
        }

    </script>
</body>
</html>