{
  "text": "```html\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Lumina - Professional Photo Editor</title>\n    <script src=\"https://cdn.tailwindcss.com\"></script>\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css\" rel=\"stylesheet\">\n    <style>\n        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');\n        \n        body {\n            font-family: 'Inter', sans-serif;\n            overflow: hidden; /* App-like feel */\n        }\n\n        /* Custom Scrollbar */\n        ::-webkit-scrollbar {\n            width: 6px;\n            height: 6px;\n        }\n        ::-webkit-scrollbar-track {\n            background: #1f2937; \n        }\n        ::-webkit-scrollbar-thumb {\n            background: #4b5563; \n            border-radius: 3px;\n        }\n        ::-webkit-scrollbar-thumb:hover {\n            background: #6b7280; \n        }\n\n        /* Range Slider Styling */\n        input[type=range] {\n            -webkit-appearance: none; \n            background: transparent; \n        }\n        input[type=range]::-webkit-slider-thumb {\n            -webkit-appearance: none;\n            height: 16px;\n            width: 16px;\n            border-radius: 50%;\n            background: #3b82f6;\n            cursor: pointer;\n            margin-top: -6px; \n            box-shadow: 0 0 2px rgba(0,0,0,0.5);\n        }\n        input[type=range]::-webkit-slider-runnable-track {\n            width: 100%;\n            height: 4px;\n            cursor: pointer;\n            background: #4b5563;\n            border-radius: 2px;\n        }\n\n        .canvas-bg {\n            background-image: \n                linear-gradient(45deg, #2a2a2a 25%, transparent 25%), \n                linear-gradient(-45deg, #2a2a2a 25%, transparent 25%), \n                linear-gradient(45deg, transparent 75%, #2a2a2a 75%), \n                linear-gradient(-45deg, transparent 75%, #2a2a2a 75%);\n            background-size: 20px 20px;\n            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;\n            background-color: #111827;\n        }\n\n        .tool-btn.active {\n            background-color: #3b82f6;\n            color: white;\n        }\n\n        /* Loading Spinner */\n        .loader {\n            border: 4px solid #f3f3f3;\n            border-top: 4px solid #3b82f6;\n            border-radius: 50%;\n            width: 30px;\n            height: 30px;\n            animation: spin 1s linear infinite;\n        }\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n    </style>\n</head>\n<body class=\"bg-gray-900 text-gray-200 h-screen flex flex-col select-none\">\n\n    <!-- Top Bar -->\n    <header class=\"h-14 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 z-20 shadow-md\">\n        <div class=\"flex items-center space-x-3\">\n            <div class=\"w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold shadow-lg\">\n                <i class=\"fa-solid fa-layer-group\"></i>\n            </div>\n            <h1 class=\"font-semibold text-lg tracking-tight text-white\">Lumina</h1>\n        </div>\n        \n        <div class=\"flex space-x-4\">\n            <button onclick=\"app.uploadImage()\" class=\"flex items-center space-x-2 px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm transition\">\n                <i class=\"fa-solid fa-upload\"></i> <span>Open Image</span>\n            </button>\n            <button onclick=\"app.downloadImage()\" class=\"flex items-center space-x-2 px-3 py-1.5 bg-blue-600 hover:bg-blue-500 rounded text-sm transition text-white\">\n                <i class=\"fa-solid fa-download\"></i> <span>Export</span>\n            </button>\n        </div>\n    </header>\n\n    <!-- Main Workspace -->\n    <div class=\"flex-1 flex overflow-hidden\">\n        \n        <!-- Left Toolbar -->\n        <aside class=\"w-16 bg-gray-800 border-r border-gray-700 flex flex-col items-center py-4 space-y-2 z-10\">\n            <button class=\"tool-btn active w-10 h-10 rounded flex items-center justify-center hover:bg-gray-700 transition\" title=\"Move (V)\" onclick=\"app.setTool('move')\">\n                <i class=\"fa-solid fa-arrows-up-down-left-right\"></i>\n            </button>\n            <button class=\"tool-btn w-10 h-10 rounded flex items-center justify-center hover:bg-gray-700 transition\" title=\"Brush (B)\" onclick=\"app.setTool('brush')\">\n                <i class=\"fa-solid fa-paintbrush\"></i>\n            </button>\n            <button class=\"tool-btn w-10 h-10 rounded flex items-center justify-center hover:bg-gray-700 transition\" title=\"Text (T)\" onclick=\"app.setTool('text')\">\n                <i class=\"fa-solid fa-font\"></i>\n            </button>\n            <button class=\"tool-btn w-10 h-10 rounded flex items-center justify-center hover:bg-gray-700 transition\" title=\"Shapes (S)\" onclick=\"app.setTool('shape')\">\n                <i class=\"fa-solid fa-shapes\"></i>\n            </button>\n            \n            <div class=\"h-px w-8 bg-gray-600 my-2\"></div>\n            \n            <div class=\"relative group\">\n                <button class=\"tool-btn w-10 h-10 rounded-full border-2 border-gray-500 flex items-center justify-center hover:scale-110 transition\" title=\"Color Picker\">\n                    <div id=\"colorPreview\" class=\"w-6 h-6 rounded-full bg-white\"></div>\n                </button>\n                <input type=\"color\" id=\"colorPicker\" class=\"absolute inset-0 opacity-0 cursor-pointer\" onchange=\"app.setColor(this.value)\">\n            </div>\n\n            <div class=\"mt-auto pb-4 flex flex-col space-y-2\">\n                 <button class=\"w-10 h-10 rounded flex items-center justify-center hover:bg-gray-700 transition text-gray-400 hover:text-white\" title=\"History\" onclick=\"app.togglePanel('history')\">\n                    <i class=\"fa-solid fa-clock-rotate-left\"></i>\n                </button>\n                <button class=\"w-10 h-10 rounded flex items-center justify-center hover:bg-gray-700 transition text-gray-400 hover:text-white\" title=\"Zoom Out\" onclick=\"app.zoom(-0.1)\">\n                    <i class=\"fa-solid fa-magnifying-glass-minus\"></i>\n                </button>\n                <button class=\"w-10 h-10 rounded flex items-center justify-center hover:bg-gray-700 transition text-gray-400 hover:text-white\" title=\"Zoom In\" onclick=\"app.zoom(0.1)\">\n                    <i class=\"fa-solid fa-magnifying-glass-plus\"></i>\n                </button>\n            </div>\n        </aside>\n\n        <!-- Center Canvas Area -->\n        <main class=\"flex-1 bg-gray-900 relative overflow-hidden flex items-center justify-center canvas-bg\" id=\"workspace\">\n            <div id=\"canvas-container\" class=\"relative shadow-2xl transition-transform duration-75 ease-out origin-center\" style=\"width: 800px; height: 600px;\">\n                <canvas id=\"mainCanvas\" width=\"800\" height=\"600\" class=\"absolute top-0 left-0 z-10 cursor-crosshair\"></canvas>\n                <!-- UI Overlay for Tools (e.g. Text Input) -->\n                <div id=\"overlay\" class=\"absolute top-0 left-0 w-full h-full z-20 pointer-events-none\"></div>\n            </div>\n            \n            <!-- Floating Info -->\n            <div class=\"absolute bottom-4 left-4 bg-gray-800/80 backdrop-blur px-3 py-1 rounded text-xs text-gray-400 pointer-events-none\">\n                <span id=\"zoomLevel\">100%</span> | <span id=\"canvasSize\">800 x 600</span>\n            </div>\n        </main>\n\n        <!-- Right Sidebar (Properties & Layers) -->\n        <aside class=\"w-72 bg-gray-800 border-l border-gray-700 flex flex-col z-10\">\n            \n            <!-- Tabs -->\n            <div class=\"flex border-b border-gray-700\">\n                <button class=\"flex-1 py-2 text-sm font-medium text-blue-400 border-b-2 border-blue-500 bg-gray-700/50\">Adjustments</button>\n                <button class=\"flex-1 py-2 text-sm font-medium text-gray-400 hover:text-gray-200 hover:bg-gray-700/30 transition\">Filters</button>\n            </div>\n\n            <!-- Adjustments Panel -->\n            <div class=\"flex-1 overflow-y-auto p-4 space-y-6\" id=\"adjustmentsPanel\">\n                \n                <!-- Opacity / Fill -->\n                <div class=\"space-y-2\">\n                    <div class=\"flex justify-between text-xs text-gray-400\">\n                        <span>Opacity</span>\n                        <span id=\"val-opacity\">100%</span>\n                    </div>\n                    <input type=\"range\" min=\"0\" max=\"100\" value=\"100\" class=\"w-full\" oninput=\"app.updateLayerOpacity(this.value)\">\n                </div>\n\n                <div class=\"h-px bg-gray-700\"></div>\n\n                <!-- Blend Mode -->\n                <div class=\"space-y-2\">\n                    <label class=\"text-xs text-gray-400\">Blending Mode</label>\n                    <select id=\"blendMode\" class=\"w-full bg-gray-700 border border-gray-600 text-xs rounded p-2 focus:outline-none focus:border-blue-500\" onchange=\"app.setBlendMode(this.value)\">\n                        <option value=\"normal\">Normal</option>\n                        <option value=\"multiply\">Multiply</option>\n                        <option value=\"screen\">Screen</option>\n                        <option value=\"overlay\">Overlay</option>\n                        <option value=\"soft-light\">Soft Light</option>\n                        <option value=\"hard-light\">Hard Light</option>\n                        <option value=\"color-dodge\">Color Dodge</option>\n                        <option value=\"color-burn\">Color Burn</option>\n                        <option value=\"difference\">Difference</option>\n                        <option value=\"exclusion\">Exclusion</option>\n                        <option value=\"hue\">Hue</option>\n                        <option value=\"saturation\">Saturation</option>\n                        <option value=\"color\">Color</option>\n                        <option value=\"luminosity\">Luminosity</option>\n                    </select>\n                </div>\n\n                <div class=\"h-px bg-gray-700\"></div>\n\n                <!-- Image Adjustments -->\n                <div class=\"space-y-4\">\n                    <label class=\"text-xs font-semibold text-gray-300 uppercase tracking-wider\">Image Adjustments</label>\n                    \n                    <!-- Brightness -->\n                    <div class=\"space-y-1\">\n                        <div class=\"flex justify-between text-xs text-gray-400\">\n                            <span>Brightness</span>\n                            <span id=\"val-brightness\">0</span>\n                        </div>\n                        <input type=\"range\" min=\"-100\" max=\"100\" value=\"0\" class=\"w-full\" oninput=\"app.updateAdjustment('brightness', this.value)\">\n                    </div>\n\n                    <!-- Contrast -->\n                    <div class=\"space-y-1\">\n                        <div class=\"flex justify-between text-xs text-gray-400\">\n                            <span>Contrast</span>\n                            <span id=\"val-contrast\">0</span>\n                        </div>\n                        <input type=\"range\" min=\"-100\" max=\"100\" value=\"0\" class=\"w-full\" oninput=\"app.updateAdjustment('contrast', this.value)\">\n                    </div>\n\n                    <!-- Saturation -->\n                    <div class=\"space-y-1\">\n                        <div class=\"flex justify-between text-xs text-gray-400\">\n                            <span>Saturation</span>\n                            <span id=\"val-saturation\">0</span>\n                        </div>\n                        <input type=\"range\" min=\"-100\" max=\"100\" value=\"0\" class=\"w-full\" oninput=\"app.updateAdjustment('saturation', this.value)\">\n                    </div>\n                    \n                    <!-- Blur -->\n                    <div class=\"space-y-1\">\n                        <div class=\"flex justify-between text-xs text-gray-400\">\n                            <span>Blur</span>\n                            <span id=\"val-blur\">0px</span>\n                        </div>\n                        <input type=\"range\" min=\"0\" max=\"20\" value=\"0\" class=\"w-full\" oninput=\"app.updateAdjustment('blur', this.value)\">\n                    </div>\n                </div>\n\n                <div class=\"h-px bg-gray-700\"></div>\n\n                <!-- Filters Presets -->\n                <div class=\"space-y-2\">\n                    <label class=\"text-xs font-semibold text-gray-300 uppercase tracking-wider\">Filters</label>\n                    <div class=\"grid grid-cols-2 gap-2\">\n                        <button onclick=\"app.applyFilter('grayscale')\" class=\"px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-xs transition\">B&W</button>\n                        <button onclick=\"app.applyFilter('sepia')\" class=\"px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-xs transition\">Sepia</button>\n                        <button onclick=\"app.applyFilter('invert')\" class=\"px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-xs transition\">Invert</button>\n                        <button onclick=\"app.applyFilter('vintage')\" class=\"px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-xs transition\">Vintage</button>\n                    </div>\n                </div>\n            </div>\n\n            <!-- Layers Panel (Bottom half of sidebar) -->\n            <div class=\"h-1/2 border-t border-gray-700 flex flex-col\">\n                <div class=\"p-3 bg-gray-800 border-b border-gray-700 flex justify-between items-center\">\n                    <span class=\"text-xs font-semibold text-gray-300 uppercase tracking-wider\">Layers</span>\n                    <div class=\"flex space-x-2\">\n                        <button onclick=\"app.addLayer()\" class=\"text-gray-400 hover:text-white\" title=\"New Layer\"><i class=\"fa-solid fa-plus\"></i></button>\n                        <button onclick=\"app.deleteLayer()\" class=\"text-gray-400 hover:text-red-400\" title=\"Delete Layer\"><i class=\"fa-solid fa-trash\"></i></button>\n                    </div>\n                </div>\n                <div id=\"layersList\" class=\"flex-1 overflow-y-auto p-2 space-y-1\">\n                    <!-- Layers injected via JS -->\n                </div>\n            </div>\n        </aside>\n    </div>\n\n    <!-- Hidden File Input -->\n    <input type=\"file\" id=\"fileInput\" accept=\"image/*\" class=\"hidden\">\n\n    <!-- Toast Notification -->\n    <div id=\"toast\" class=\"fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50\">\n        Action Completed\n    </div>\n\n    <script>\n        /**\n         * Lumina Photo Editor Core Logic\n         * Handles Canvas rendering, Layers, History, and Tools.\n         */\n        class PhotoEditor {\n            constructor() {\n                this.canvas = document.getElementById('mainCanvas');\n                this.ctx = this.canvas.getContext('2d');\n                this.layers = [];\n                this.activeLayerIndex = 0;\n                this.zoomLevel = 1.0;\n                this.isDragging = false;\n                this.lastX = 0;\n                this.lastY = 0;\n                \n                // Tool State\n                this.tool = 'move'; // move, brush, text, shape\n                this.color = '#ffffff';\n                this.brushSize = 5;\n                this.isDrawing = false;\n\n                // History\n                this.history = [];\n                this.historyStep = -1;\n                this.maxHistory = 20;\n\n                // Init\n                this.init();\n            }\n\n            init() {\n                // Create initial blank layer\n                this.addLayer();\n                \n                // Event Listeners\n                this.setupEventListeners();\n                \n                // Initial Render\n                this.render();\n                this.updateLayersUI();\n                \n                // Keyboard shortcuts\n                document.addEventListener('keydown', (e) => this.handleKeydown(e));\n            }\n\n            setupEventListeners() {\n                const container = document.getElementById('canvas-container');\n\n                // Workspace Panning (Middle Mouse or Space+Drag logic simplified to click+drag on background)\n                // For this demo, we handle tool interactions on the canvas\n                \n                this.canvas.addEventListener('mousedown', (e) => this.onMouseDown(e));\n                this.canvas.addEventListener('mousemove', (e) => this.onMouseMove(e));\n                this.canvas.addEventListener('mouseup', (e) => this.onMouseUp(e));\n                this.canvas.addEventListener('mouseout', (e) => this.onMouseUp(e));\n                \n                // File Input\n                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileSelect(e));\n            }\n\n            // --- Layer Management ---\n\n            addLayer(imageSrc = null) {\n                const layerCanvas = document.createElement('canvas');\n                layerCanvas.width = this.canvas.width;\n                layerCanvas.height = this.canvas.height;\n                const layerCtx = layerCanvas.getContext('2d');\n\n                // If image provided, draw it\n                if (imageSrc) {\n                    const img = new Image();\n                    img.onload = () => {\n                        // Center and fit image\n                        const scale = Math.min(this.canvas.width / img.width, this.canvas.height / img.height);\n                        const x = (this.canvas.width / 2) - (img.width / 2) * scale;\n                        const y = (this.canvas.height / 2) - (img.height / 2) * scale;\n                        layerCtx.drawImage(img, x, y, img.width * scale, img.height * scale);\n                        this.saveState();\n                        this.render();\n                    };\n                    img.src = imageSrc;\n                }\n\n                const newLayer = {\n                    id: Date.now(),\n                    name: imageSrc ? 'Image' : `Layer ${this.layers.length + 1}`,\n                    canvas: layerCanvas,\n                    ctx: layerCtx,\n                    visible: true,\n                    opacity: 100,\n                    blendMode: 'normal',\n                    adjustments: {\n                        brightness: 0,\n                        contrast: 0,\n                        saturation: 0,\n                        blur: 0\n                    }\n                };\n\n                this.layers.push(newLayer);\n                this.activeLayerIndex = this.layers.length - 1;\n                this.updateLayersUI();\n                this.saveState(); // Save history\n                this.render();\n            }\n\n            deleteLayer() {\n                if (this.layers.length <= 1) {\n                    this.showToast(\"Cannot delete the last layer\");\n                    return;\n                }\n                this.layers.splice(this.activeLayerIndex, 1);\n                this.activeLayerIndex = Math.max(0, this.activeLayerIndex - 1);\n                this.updateLayersUI();\n                this.saveState();\n                this.render();\n            }\n\n            setActiveLayer(index) {\n                this.activeLayerIndex = index;\n                this.updateLayersUI();\n                // Update UI controls to reflect this layer's props\n                const layer = this.layers[index];\n                document.getElementById('blendMode').value = layer.blendMode;\n                // Update sliders if needed (simplified for demo)\n            }\n\n            updateLayerOpacity(val) {\n                const layer = this.layers[this.activeLayerIndex];\n                if(layer) {\n                    layer.opacity = parseInt(val);\n                    document.getElementById('val-opacity').innerText = val + '%';\n                    this.render();\n                }\n            }\n\n            setBlendMode(mode) {\n                const layer = this.layers[this.activeLayerIndex];\n                if(layer) {\n                    layer.blendMode = mode;\n                    this.render();\n                }\n            }\n\n            // --- Rendering ---\n\n            render() {\n                // Clear main canvas\n                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\n                \n                // Composite layers\n                this.layers.forEach(layer => {\n                    if (!layer.visible) return;\n\n                    this.ctx.save();\n                    \n                    // Apply Global Composite Operation\n                    // Mapping standard blend modes to canvas equivalents\n                    const blendMap = {\n                        'normal': 'source-over',\n                        'multiply': 'multiply',\n                        'screen': 'screen',\n                        'overlay': 'overlay',\n                        'soft-light': 'soft-light',\n                        'hard-light': 'hard-light',\n                        'color-dodge': 'color-dodge',\n                        'color-burn': 'color-burn',\n                        'difference': 'difference',\n                        'exclusion': 'exclusion',\n                        'hue': 'hue',\n                        'saturation': 'saturation',\n                        'color': 'color',\n                        'luminosity': 'luminosity'\n                    };\n                    \n                    this.ctx.globalCompositeOperation = blendMap[layer.blendMode] || 'source-over';\n                    this.ctx.globalAlpha = layer.opacity / 100;\n\n                    // Apply Adjustments via Filter\n                    // Note: Canvas filter string syntax is \"brightness(1.5) contrast(1.2)...\"\n                    // Our sliders are -100 to 100 or 0-20.\n                    let filterString = '';\n                    if (layer.adjustments.brightness !== 0) {\n                        filterString += `brightness(${1 + (layer.adjustments.brightness / 100)}) `;\n                    }\n                    if (layer.adjustments.contrast !== 0) {\n                        filterString += `contrast(${1 + (layer.adjustments.contrast / 100)}) `;\n                    }\n                    if (layer.adjustments.saturation !== 0) {\n                        filterString += `saturate(${1 + (layer.adjustments.saturation / 100)}) `;\n                    }\n                    if (layer.adjustments.blur > 0) {\n                        filterString += `blur(${layer.adjustments.blur}px) `;\n                    }\n\n                    if (filterString) {\n                        this.ctx.filter = filterString;\n                    }\n\n                    // Draw the layer\n                    this.ctx.drawImage(layer.canvas, 0, 0);\n                    \n                    this.ctx.restore();\n                });\n            }\n\n            updateLayersUI() {\n                const list = document.getElementById('layersList');\n                list.innerHTML = '';\n                \n                // Iterate backwards to show top layers at top of list (Photoshop style)\n                for (let i = this.layers.length - 1; i >= 0; i--) {\n                    const layer = this.layers[i];\n                    const isActive = i === this.activeLayerIndex;\n                    \n                    const div = document.createElement('div');\n                    div.className = `flex items-center p-2 rounded cursor-pointer transition ${isActive ? 'bg-blue-600/30 border border-blue-500/50' : 'hover:bg-gray-700 border border-transparent'}`;\n                    div.onclick = () => this.setActiveLayer(i);\n\n                    div.innerHTML = `\n                        <div class=\"w-8 h-8 bg-gray-600 rounded mr-3 overflow-hidden border border-gray-500\">\n                            <img src=\"${layer.canvas.toDataURL()}\" class=\"w-full h-full object-cover\">\n                        </div>\n                        <div class=\"flex-1 min-w-0\">\n                            <div class=\"text-xs font-medium text-gray-200 truncate\">${layer.name}</div>\n                            <div class=\"text-[10px] text-gray-500 uppercase\">${layer.blendMode}</div>\n                        </div>\n                        <button class=\"text-gray-400 hover:text-white p-1\" onclick=\"event.stopPropagation(); app.toggleLayerVisibility(${i})\">\n                            <i class=\"fa-solid ${layer.visible ? 'fa-eye' : 'fa-eye-slash'}\"></i>\n                        </button>\n                    `;\n                    list.appendChild(div);\n                }\n            }\n\n            toggleLayerVisibility(index) {\n                this.layers[index].visible = !this.layers[index].visible;\n                this.updateLayersUI();\n                this.render();\n            }\n\n            // --- Tools & Interactions ---\n\n            setTool(toolName) {\n                this.tool = toolName;\n                // Update UI\n                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));\n                event.currentTarget.classList.add('active'); // Note: event might not be reliable here if called programmatically, usually pass 'this' or ID\n                // Simple fix for the passed HTML structure:\n                const btns = document.querySelectorAll('.tool-btn');\n                if(toolName === 'move') btns[0].classList.add('active');\n                if(toolName === 'brush') btns[1].classList.add('active');\n                if(toolName === 'text') btns[2].classList.add('active');\n                if(toolName === 'shape') btns[3].classList.add('active');\n            }\n\n            setColor(hex) {\n                this.color = hex;\n                document.getElementById('colorPreview').style.backgroundColor = hex;\n            }\n\n            getMousePos(evt) {\n                const rect = this.canvas.getBoundingClientRect();\n                const scaleX = this.canvas.width / rect.width;\n                const scaleY = this.canvas.height / rect.height;\n                return {\n                    x: (evt.clientX - rect.left) * scaleX,\n                    y: (evt.clientY - rect.top) * scaleY\n                };\n            }\n\n            onMouseDown(e) {\n                if (this.layers.length === 0) return;\n                this.isDrawing = true;\n                const pos = this.getMousePos(e);\n                this.lastX = pos.x;\n                this.lastY = pos.y;\n\n                const ctx = this.layers[this.activeLayerIndex].ctx;\n\n                if (this.tool === 'brush') {\n                    ctx.beginPath();\n                    ctx.moveTo(this.lastX, this.lastY);\n                    ctx.lineCap = 'round';\n                    ctx.lineJoin = 'round';\n                    ctx.lineWidth = this.brushSize;\n                    ctx.strokeStyle = this.color;\n                } else if (this.tool === 'text') {\n                    this.addTextLayer(pos.x, pos.y);\n                    this.isDrawing = false; // Text is single click\n                } else if (this.tool === 'shape') {\n                    ctx.beginPath();\n                    ctx.fillStyle = this.color;\n                }\n            }\n\n            onMouseMove(e) {\n                if (!this.isDrawing) return;\n                const pos = this.getMousePos(e);\n                const ctx = this.layers[this.activeLayerIndex].ctx;\n\n                if (this.tool === 'brush') {\n                    ctx.lineTo(pos.x, pos.y);\n                    ctx.stroke();\n                    this.render(); // Re-composite\n                } else if (this.tool === 'shape') {\n                    // Simple rect preview logic (requires clearing rect, complex on single canvas without temp layer)\n                    // For simplicity, we just draw the rect on drag end or simple drag box\n                    // Let's do simple drag box\n                    // Note: Real implementation needs a temp canvas for preview.\n                    // Here we just update last pos for a rect on mouse up\n                }\n                \n                this.lastX = pos.x;\n                this.lastY = pos.y;\n            }\n\n            onMouseUp(e) {\n                if (!this.isDrawing) return;\n                this.isDrawing = false;\n                \n                const pos = this.getMousePos(e);\n                const layer = this.layers[this.activeLayerIndex];\n                \n                if (this.tool === 'shape') {\n                    const width = pos.x - this.lastX;\n                    const height = pos.y - this.lastY;\n                    layer.ctx.fillRect(this.lastX, this.lastY, width, height);\n                    this.render();\n                    this.saveState();\n                } else if (this.tool === 'brush') {\n                    this.saveState();\n                }\n            }\n\n            addTextLayer(x, y) {\n                const text = prompt(\"Enter text:\", \"Hello World\");\n                if (text) {\n                    const ctx = this.layers[this.activeLayerIndex].ctx;\n                    ctx.font = \"30px Inter\";\n                    ctx.fillStyle = this.color;\n                    ctx.fillText(text, x, y);\n                    this.render();\n                    this.saveState();\n                }\n            }\n\n            // --- Adjustments & Filters ---\n\n            updateAdjustment(type, value) {\n                const layer = this.layers[this.activeLayerIndex];\n                if (layer) {\n                    layer.adjustments[type] = parseInt(value);\n                    document.getElementById(`val-${type}`).innerText = value + (type === 'blur' ? 'px' : '');\n                    this.render();\n                }\n            }\n\n            applyFilter(type) {\n                const layer = this.layers[this.activeLayerIndex];\n                if (!layer) return;\n                const ctx = layer.ctx;\n\n                // Get current image data to process\n                // Note: Direct pixel manipulation is heavy. Using context filters for simple ones.\n                \n                if (type === 'grayscale') {\n                    ctx.filter = 'grayscale(100%)';\n                    ctx.drawImage(layer.canvas, 0, 0); // Re-draw self with filter\n                    ctx.filter = 'none';\n                } else if (type === 'sepia') {\n                    ctx.filter = 'sepia(100%)';\n                    ctx.drawImage(layer.canvas, 0, 0);\n                    ctx.filter = 'none';\n                } else if (type === 'invert') {\n                    ctx.filter = 'invert(100%)';\n                    ctx.drawImage(layer.canvas, 0, 0);\n                    ctx.filter = 'none';\n                } else if (type === 'vintage') {\n                    // Composite effect: Sepia + Contrast\n                    ctx.filter = 'sepia(50%) contrast(120%) brightness(90%)';\n                    ctx.drawImage(layer.canvas, 0, 0);\n                    ctx.filter = 'none';\n                }\n\n                this.render();\n                this.saveState();\n            }\n\n            // --- History (Undo/Redo) ---\n\n            saveState() {\n                // Remove redo steps\n                if (this.historyStep < this.history.length - 1) {\n                    this.history = this.history.slice(0, this.historyStep + 1);\n                }\n\n                // Deep copy layers (expensive but necessary for undo)\n                // Optimization: Only save changed layer? For this demo, we save full state for simplicity or just layer data.\n                // Let's save the image data of the active layer to keep it performant enough for a demo.\n                \n                const layerCopies = this.layers.map(l => {\n                    const c = document.createElement('canvas');\n                    c.width = l.canvas.width;\n                    c.height = l.canvas.height;\n                    c.getContext('2d').drawImage(l.canvas, 0, 0);\n                    return {\n                        ...l,\n                        canvas: c,\n                        ctx: c.getContext('2d')\n                    };\n                });\n\n                this.history.push({\n                    layers: layerCopies,\n                    activeIndex: this.activeLayerIndex\n                });\n\n                if (this.history.length > this.maxHistory) {\n                    this.history.shift();\n                } else {\n                    this.historyStep++;\n                }\n            }\n\n            undo() {\n                if (this.historyStep > 0) {\n                    this.historyStep--;\n                    this.restoreState(this.history[this.historyStep]);\n                }\n            }\n\n            redo() {\n                if (this.historyStep < this.history.length - 1) {\n                    this.historyStep++;\n                    this.restoreState(this.history[this.historyStep]);\n                }\n            }\n\n            restoreState(state) {\n                this.layers = state.layers.map(l => ({...l})); // Shallow copy + canvas ref\n                this.activeLayerIndex = state.activeIndex;\n                this.updateLayersUI();\n                this.render();\n            }\n\n            // --- IO ---\n\n            uploadImage() {\n                document.getElementById('fileInput').click();\n            }\n\n            handleFileSelect(e) {\n                const file = e.target.files[0];\n                if (file) {\n                    const reader = new FileReader();\n                    reader.onload = (event) => {\n                        this.addLayer(event.target.result);\n                    };\n                    reader.readAsDataURL(file);\n                }\n            }\n\n            downloadImage() {\n                // Create a temp canvas to flatten\n                const tempCanvas = document.createElement('canvas');\n                tempCanvas.width = this.canvas.width;\n                tempCanvas.height = this.canvas.height;\n                const tempCtx = tempCanvas.getContext('2d');\n\n                // Draw white background (optional)\n                tempCtx.fillStyle = '#ffffff';\n                tempCtx.fillRect(0,0, tempCanvas.width, tempCanvas.height);\n\n                // Draw all layers\n                this.layers.forEach(layer => {\n                    if(layer.visible) {\n                        tempCtx.globalAlpha = layer.opacity / 100;\n                        // Note: Filters and blend modes need to be re-applied here for export if we want exact WYSIWYG\n                        // For simplicity, we draw raw canvas. \n                        // A full export requires re-running the render logic onto the temp canvas.\n                        \n                        // Re-apply filter string\n                        let filterString = '';\n                        if (layer.adjustments.brightness !== 0) filterString += `brightness(${1 + (layer.adjustments.brightness / 100)}) `;\n                        if (layer.adjustments.contrast !== 0) filterString += `contrast(${1 + (layer.adjustments.contrast / 100)}) `;\n                        if (layer.adjustments.saturation !== 0) filterString += `saturate(${1 + (layer.adjustments.saturation / 100)}) `;\n                        if (layer.adjustments.blur > 0) filterString += `blur(${layer.adjustments.blur}px) `;\n                        \n                        tempCtx.filter = filterString;\n                        \n                        const blendMap = {\n                            'normal': 'source-over', 'multiply': 'multiply', 'screen': 'screen', 'overlay': 'overlay'\n                        };\n                        tempCtx.globalCompositeOperation = blendMap[layer.blendMode] || 'source-over';\n                        \n                        tempCtx.drawImage(layer.canvas, 0, 0);\n                    }\n                });\n\n                const link = document.createElement('a');\n                link.download = 'lumina-edit.png';\n                link.href = tempCanvas.toDataURL();\n                link.click();\n                this.showToast(\"Image Downloaded\");\n            }\n\n            zoom(delta) {\n                this.zoomLevel += delta;\n                this.zoomLevel = Math.max(0.1, Math.min(3.0, this.zoomLevel));\n                document.getElementById('canvas-container').style.transform = `scale(${this.zoomLevel})`;\n                document.getElementById('zoomLevel').innerText = Math.round(this.zoomLevel * 100) + '%';\n            }\n\n            togglePanel(panelName) {\n                // Simple toggle logic could go here, for now history is integrated\n                this.showToast(\"History: \" + this.historyStep + \" steps\");\n            }\n\n            handleKeydown(e) {\n                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {\n                    e.preventDefault();\n                    this.undo();\n                }\n                if ((e.ctrlKey || e.metaKey) && e.key === 'y') {\n                    e.preventDefault();\n                    this.redo();\n                }\n                if ((e.ctrlKey || e.metaKey) && e.key === 's') {\n                    e.preventDefault();\n                    this.downloadImage();\n                }\n            }\n\n            showToast(msg) {\n                const toast = document.getElementById('toast');\n                toast.innerText = msg;\n                toast.classList.remove('translate-y-20', 'opacity-0');\n                setTimeout(() => {\n                    toast.classList.add('translate-y-20', 'opacity-0');\n                }, 2000);\n            }\n        }\n\n        // Initialize App\n        const app = new PhotoEditor();\n\n    </script>\n</body>\n</html>\n```"
}